<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Charge Customer | Sailor Skills</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css?v=3.0">
</head>
<body>
    <!-- Navigation Header with Hamburger Menu -->
    <header class="navigation-header">
        <div class="nav-container">
            <a href="https://www.sailorskills.com/" class="nav-logo">SAILOR SKILLS</a>
            <button class="nav-toggle" id="navToggle" aria-label="Menu">
                <span class="hamburger"></span>
                <span class="hamburger"></span>
                <span class="hamburger"></span>
            </button>
            <nav class="nav-links" id="navLinks">
                <a href="https://www.sailorskills.com/">HOME</a>
                <a href="https://www.sailorskills.com/training">TRAINING</a>
                <a href="https://www.sailorskills.com/diving">DIVING</a>
                <a href="https://www.sailorskills.com/detailing">DETAILING</a>
                <a href="https://www.sailorskills.com/deliveries">DELIVERIES</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Hero Header -->
        <div class="hero-header">
            <div class="admin-badge">ADMIN MODE</div>
            <div class="hero-content">
                <div class="hero-brand">SAILOR SKILLS</div>
                <h1 class="hero-service">ADMIN</h1>
                <div class="hero-tagline">CHARGE CUSTOMER</div>
                <div class="hero-subtitle">Use pricing calculator for existing customers</div>
            </div>
        </div>

        <!-- Add Payment Method Modal -->
        <div id="paymentMethodModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closePaymentMethodForm()">&times;</span>
                <h2>Add Payment Method</h2>
                <div id="paymentCustomerInfo" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <!-- Customer info will be populated here -->
                </div>
                <form id="payment-form" autocomplete="off" data-private="true">
                    <div id="card-element" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                        <!-- Stripe card element will be mounted here -->
                    </div>
                    <div id="card-errors" role="alert" style="color: #e74c3c; margin-top: 10px; min-height: 20px;"></div>
                    <div class="form-actions" style="margin-top: 20px;">
                        <button type="button" onclick="closePaymentMethodForm()" class="cancel-btn">Cancel</button>
                        <button type="submit" id="submit-payment" class="submit-btn">Add Card</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Customer Modal -->
        <div id="newCustomerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="window.adminApp.closeCreateCustomerForm()">&times;</span>
                <h2>Create New Customer</h2>
                <form id="newCustomerForm">
                    <div class="form-group">
                        <label for="newCustomerName">Full Name *</label>
                        <input type="text" id="newCustomerName" name="name" required placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerEmail">Email *</label>
                        <input type="email" id="newCustomerEmail" name="email" required placeholder="customer@example.com">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerPhone">Phone</label>
                        <input type="tel" id="newCustomerPhone" name="phone" placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerBoatName">Boat Name</label>
                        <input type="text" id="newCustomerBoatName" name="boat_name" placeholder="Serenity">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerBoatLength">Boat Length (feet)</label>
                        <input type="number" id="newCustomerBoatLength" name="boat_length" min="20" max="100" placeholder="35">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerBoatMake">Boat Make/Manufacturer</label>
                        <input type="text" id="newCustomerBoatMake" name="boat_make" placeholder="Catalina, Beneteau, etc.">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerBoatModel">Boat Model</label>
                        <input type="text" id="newCustomerBoatModel" name="boat_model" placeholder="Oceanis 45, Hunter 36, etc.">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerBoatYear">Boat Year</label>
                        <input type="number" id="newCustomerBoatYear" name="boat_year" min="1900" max="2025" placeholder="2018">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerMarina">Marina</label>
                        <input type="text" id="newCustomerMarina" name="marina" placeholder="San Francisco Marina">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerDock">Dock</label>
                        <input type="text" id="newCustomerDock" name="dock" placeholder="A, B, C, etc.">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerSlip">Slip Number</label>
                        <input type="text" id="newCustomerSlip" name="slip" placeholder="123">
                    </div>
                    <div class="form-group">
                        <label for="newCustomerNotes">Notes</label>
                        <textarea id="newCustomerNotes" name="description" rows="3" placeholder="Any additional notes about the customer or boat..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="window.adminApp.closeCreateCustomerForm()" class="cancel-btn">Cancel</button>
                        <button type="submit" class="submit-btn">Create Customer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Customer Selection Modal -->
        <div id="customerSelectionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeCustomerSelectionModal()">&times;</span>
                <h2>Select Customer</h2>
                <div id="modalCustomerList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Customer list will be populated here -->
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeCustomerSelectionModal()" class="cancel-btn">Cancel</button>
                    <button type="button" onclick="confirmModalCustomerSelection()" class="submit-btn">Select Customer</button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Customer Selection -->
            <div class="customer-section">
                <h2>Select Customer</h2>
                <div class="customer-controls">
                    <input type="text"
                           id="customerSearch"
                           class="customer-search-input"
                           placeholder="Search by name, email, or boat name...">
                    <div class="customer-buttons">
                        <button onclick="window.adminApp.searchCustomers()" class="customer-btn">Search</button>
                        <button onclick="window.adminApp.loadRecentCustomers()" class="customer-btn">Show Recent</button>
                        <button onclick="window.adminApp.showCreateCustomerForm()" class="customer-btn new-customer-btn">+ New Customer</button>
                    </div>
                </div>
                <div id="customerList" class="customer-list" style="display: none;"></div>
                <div id="selectedCustomer" class="selected-customer-display">
                    <strong>Selected Customer:</strong>
                    <span id="selectedCustomerInfo"></span>
                </div>
            </div>

            <!-- Service Selection -->
            <div class="service-selector">
                <h2>Select Service Type</h2>
                <div id="simpleServiceButtons" class="simple-service-buttons">
                    <button onclick="window.selectServiceDirect('recurring_cleaning')" class="simple-service-btn" style="padding: 16px 20px; background: linear-gradient(135deg, #5B3A99 0%, #6B4A9E 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 6px rgba(91, 58, 153, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        üîÑ Recurring Cleaning
                    </button>
                    <button onclick="window.selectServiceDirect('onetime_cleaning')" class="simple-service-btn" style="padding: 16px 20px; background: linear-gradient(135deg, #1E5F8E 0%, #2471A3 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 6px rgba(30, 95, 142, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        ‚ú® One-Time Cleaning
                    </button>
                    <button onclick="window.selectServiceDirect('underwater_inspection')" class="simple-service-btn" style="padding: 16px 20px; background: linear-gradient(135deg, #0E7BA7 0%, #138FB5 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 6px rgba(14, 123, 167, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        üîç Underwater Inspection
                    </button>
                    <button onclick="window.selectServiceDirect('item_recovery')" class="simple-service-btn" style="padding: 16px 20px; background: linear-gradient(135deg, #C73E79 0%, #D84361 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 6px rgba(199, 62, 121, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        üîë Item Recovery
                    </button>
                    <button onclick="window.selectServiceDirect('propeller_service')" class="simple-service-btn" style="padding: 16px 20px; background: linear-gradient(135deg, #D68910 0%, #E59E1B 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 6px rgba(214, 137, 16, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        ‚öôÔ∏è Propeller Service
                    </button>
                    <button onclick="window.selectServiceDirect('anodes_only')" class="simple-service-btn" style="padding: 16px 20px; background: linear-gradient(135deg, #C0392B 0%, #E74C3C 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; box-shadow: 0 4px 6px rgba(192, 57, 43, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                        üîã Anodes Only
                    </button>
                </div>

                <div id="wizardContainer" style="display: none;">
                    <div id="wizardContent"></div>
                </div>
            </div>

            <div id="boatConfigSection" class="boat-config-section" style="display: none !important; /* PERMANENTLY HIDDEN - handled by wizard */">
                <!-- Legacy boat configuration - now handled by wizard -->
            </div>

            <div class="boat-details" style="display: none !important; /* PERMANENTLY HIDDEN - handled by wizard */">
                <!-- Legacy boat details - now handled by wizard -->
            </div>

            <!-- Dynamic Pricing Display -->
            <div id="pricingDisplay" class="pricing-display" style="display: none;">
                <h3>üí∞ Price Breakdown</h3>
                <div id="priceBreakdown" class="price-breakdown"></div>
                <div class="charge-button-container" style="margin-top: 20px;">
                    <input type="number" id="editableAmount" class="amount-input" step="0.01" min="0"
                           style="width: 150px; padding: 10px; font-size: 18px; margin-right: 10px;"
                           onchange="updateChargeButton()">
                    <button id="pricingChargeButton" class="charge-button" onclick="chargeCustomer()" disabled>
                        üí≥ Charge Customer
                    </button>
                </div>
            </div>

            <!-- Charge Summary -->
            <div class="charge-summary">
                <h3>üí≥ Charge Summary</h3>
                <div class="charge-details" id="chargeDetails">
                    <div id="chargeSummaryContent">
                        <p>Select a customer and service to see pricing</p>
                    </div>
                </div>
                <div class="charge-button-container">
                    <button id="chargeButton" class="charge-button" disabled onclick="chargeCustomer()">
                        üí≥ Charge Customer
                    </button>
                    <button class="charge-button quote-button" onclick="window.adminApp.generateQuote()">
                        üìÑ Generate Quote
                    </button>
                </div>
            </div>

            <!-- Result Display -->
            <div id="chargeResult" class="charge-result"></div>

            <!-- Anode Management Section -->
            <div id="anodeSection" class="anode-section">
                <div class="daily-schedule">
                    <h3>üìÖ Daily Schedule</h3>
                    <div class="schedule-date-selector">
                        <input type="date" id="serviceDate" value="">
                        <button onclick="loadDailySchedule()" class="customer-btn">Load Schedule</button>
                    </div>
                    <div id="boatScheduleList" class="boat-schedule-list"></div>
                </div>

                <div class="anode-selector">
                    <h3>üîã Select Anodes</h3>
                    <div id="anodeCategories" class="anode-categories"></div>
                    <div id="anodeGrid" class="anode-grid"></div>

                    <div class="anode-cart">
                        <h4>Shopping Cart</h4>
                        <div id="cartItems"></div>
                        <div class="cart-total">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="cartSubtotal">$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Labor:</span>
                                <span id="cartLabor">$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>Tax:</span>
                                <span id="cartTax">$0.00</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total:</span>
                                <span id="cartTotal">$0.00</span>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <h5>Pricing Settings</h5>
                            <div class="input-group">
                                <label>Tax Rate (%)</label>
                                <input type="number" id="taxRate" value="10.75" step="0.01" onchange="updateAnodeCart()">
                            </div>
                            <div class="input-group">
                                <label>Markup (%)</label>
                                <input type="number" id="markupRate" value="20" step="1" onchange="updateAnodeCart()">
                            </div>
                            <div class="input-group">
                                <label>Labor per Anode ($)</label>
                                <input type="number" id="laborCharge" value="15" step="1" onchange="updateAnodeCart()">
                            </div>
                        </div>

                        <button class="charge-anode-btn" onclick="chargeAnodes()" disabled>
                            üí≥ Charge Customer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden inputs for tracking state -->
    <input type="hidden" id="serviceKey" value="">
    <input type="hidden" id="servicePrice" value="0">
    <input type="hidden" id="anodesToInstall" value="0">

    <!-- External Scripts -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Define selectServiceDirect immediately for button onclick handlers
        window.selectServiceDirect = function(serviceKey) {
            console.log('Service selected:', serviceKey);
            window.currentServiceKey = serviceKey;

            // Determine if it's a cleaning service
            const isCleaningService = serviceKey === 'recurring_cleaning' || serviceKey === 'onetime_cleaning';

            // Call renderConsolidatedForm
            if (window.renderConsolidatedForm) {
                window.renderConsolidatedForm(isCleaningService, serviceKey);
            } else {
                console.error('renderConsolidatedForm not yet loaded');
            }

            // Update pricing
            if (window.updatePricing) {
                window.updatePricing();
            }

            // Update charge summary
            if (window.updateChargeSummary) {
                window.updateChargeSummary();
            }
        };
    </script>
    <script src="script.js" type="module"></script>
    <script type="module">
        import { AdminApp } from './admin.js';
        import './admin-wizard.js';
        import './admin-payment.js';

        // Initialize admin app
        window.adminApp = new AdminApp();

        // Make sure functions are globally available
        window.updatePricing = window.updatePricing || function() {
            console.log('updatePricing called');
        };

        window.updateChargeSummary = window.updateChargeSummary || function() {
            console.log('updateChargeSummary called');
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date for anode scheduling
            const today = new Date().toISOString().split('T')[0];
            const serviceDateInput = document.getElementById('serviceDate');
            if (serviceDateInput) {
                serviceDateInput.value = today;
            }

            // Initialize navigation toggle
            const navToggle = document.getElementById('navToggle');
            const navLinks = document.getElementById('navLinks');

            if (navToggle && navLinks) {
                navToggle.addEventListener('click', function() {
                    navLinks.classList.toggle('active');
                    navToggle.classList.toggle('active');
                });
            }
        });
    </script>
</body>
</html>