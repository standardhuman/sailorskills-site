<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Admin - Charge Customer | Sailor Skills</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin.css">
    <style>
        /* Admin specific styles - matching cost calculator theme */
        body {
            background-color: #ffffff;
            min-height: 100vh;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            color: #181818;
        }
        
        /* Hero Header - matching cost calculator */
        .hero-header {
            background-color: #ffffff;
            min-height: 229px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-bottom: 1px solid #345475;
        }
        
        .hero-content {
            text-align: center;
            padding: 30px 20px 40px;
        }
        
        .hero-brand {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            font-weight: 400;
            color: #181818;
            letter-spacing: 0.2em;
            margin-bottom: -10px;
            text-transform: uppercase;
        }
        
        .hero-service {
            font-family: 'Montserrat', sans-serif;
            font-size: 100px;
            font-weight: 400;
            color: #181818;
            line-height: 1;
            margin: 0 0 -5px 0;
            padding: 0;
            letter-spacing: normal;
        }
        
        .hero-tagline {
            font-family: 'Montserrat', sans-serif;
            font-size: 20px;
            font-weight: 400;
            color: #6d7b89;
            line-height: 1.5;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .hero-subtitle {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            font-weight: 400;
            color: #6d7b89;
            font-style: italic;
            margin-top: 5px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 40px 40px;
            font-family: 'Montserrat', sans-serif;
        }

        /* Admin Tools Button Hover Effects */
        .admin-tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3) !important;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .admin-badge {
                top: 70px !important;
                right: 10px !important;
                padding: 6px 12px !important;
                font-size: 10px !important;
            }

            /* Mobile hero adjustments */
            .hero-service {
                font-size: 60px !important;
            }

            .hero-brand, .hero-tagline {
                font-size: 16px !important;
            }

            .hero-content {
                padding: 20px 15px 30px !important;
            }

            /* Mobile form adjustments */
            .customer-controls {
                flex-direction: column !important;
            }

            .amount-input, .customer-search-input {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 16px;
            font-weight: bold;
            text-align: center;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Customer selector styles matching the cost calculator design */
        .customer-section {
            background: #ffffff;
            padding: 30px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .customer-section h2 {
            color: #181818;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 400;
            letter-spacing: normal;
        }

        .customer-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .customer-search-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-height: 40px;
            -webkit-appearance: none;
        }
        

        .customer-search-input:focus {
            border-color: #345475;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 84, 117, 0.1);
        }

        .customer-btn {
            padding: 8px 16px;
            background-color: #345475;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-height: 36px;
            white-space: nowrap;
        }

        .customer-btn:hover {
            background-color: #2a3f5f;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(52, 68, 117, 0.3);
        }

        .customer-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
        }

        .customer-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .customer-item:last-child {
            border-bottom: none;
        }

        .customer-item:hover {
            background: linear-gradient(to right, rgba(52, 84, 117, 0.05), rgba(52, 84, 117, 0.02));
        }

        .customer-item.selected {
            background: #345475;
            color: white;
        }

        .customer-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .customer-email {
            font-size: 14px;
            opacity: 0.8;
        }

        .customer-payment {
            display: inline-block;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .customer-payment.has-card {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }

        .customer-payment.no-card {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .customer-item.selected .customer-payment {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .selected-customer-display {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(to right, rgba(52, 84, 117, 0.1), rgba(52, 84, 117, 0.05));
            border-radius: 8px;
            border: 2px solid #345475;
            display: none;
        }

        .selected-customer-display.active {
            display: block;
        }

        /* Charge summary matching the price display style */
        .charge-summary {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid #e0e0e0;
        }

        .charge-summary h3 {
            color: #181818;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 400;
        }

        .charge-details {
            background: white;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .charge-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .charge-detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-top: 10px;
            font-size: 20px;
            font-weight: 600;
            color: #181818;
        }

        .charge-button {
            width: 100%;
            padding: 18px;
            background-color: #345475;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .charge-button:hover:not(:disabled) {
            background-color: #2a3f5f;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 68, 117, 0.3);
        }

        .charge-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .charge-button.processing {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        /* Result messages */
        .charge-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .charge-result.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            color: #155724;
        }

        .charge-result.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border: 2px solid #dc3545;
            color: #721c24;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-customers {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* Service selector section to match cost calculator */
        .service-selector {
            background: #ffffff;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        .service-selector h2 {
            color: #181818;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 400;
            letter-spacing: normal;
        }
        
        /* Fade transition styles for service selection */
        .service-selection-grid {
            position: relative;
            min-height: 300px;
        }
        
        .service-fade-container {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        
        .service-fade-container.fade-out {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        
        .service-fade-container.fade-in {
            opacity: 0;
            animation: serviceFadeIn 0.4s ease-in-out 0.2s forwards;
        }
        
        @keyframes serviceFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Button group styles for options */
        .option-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .option-button {
            padding: 14px 20px;
            border: 2px solid #ddd;
            background-color: #fff;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
            text-align: center;
            flex: 1;
            min-height: 52px;
        }
        
        .option-button:hover {
            border-color: #345475;
            background-color: #f8f9fa;
        }
        
        .option-button.selected {
            background-color: #345475;
            color: white;
            border-color: #345475;
        }
        
        .option-button.selected:hover {
            background-color: #2a3f5f;
            border-color: #2a3f5f;
        }
        
        /* Paint condition specific colors - higher specificity */
        .option-button.paint-excellent.selected {
            background-color: #27ae60 !important;
            border-color: #27ae60 !important;
            color: white !important;
        }
        .option-button.paint-good.selected {
            background-color: #3498db !important;
            border-color: #3498db !important;
            color: white !important;
        }
        .option-button.paint-fair.selected {
            background-color: #f39c12 !important;
            border-color: #f39c12 !important;
            color: white !important;
        }
        .option-button.paint-poor.selected {
            background-color: #e67e22 !important;
            border-color: #e67e22 !important;
            color: white !important;
        }
        .option-button.paint-missing.selected {
            background-color: #e74c3c !important;
            border-color: #e74c3c !important;
            color: white !important;
        }
        
        /* Growth level specific colors - higher specificity */
        .option-button.growth-minimal.selected {
            background-color: #27ae60 !important;
            border-color: #27ae60 !important;
            color: white !important;
        }
        .option-button.growth-moderate.selected {
            background-color: #f39c12 !important;
            border-color: #f39c12 !important;
            color: white !important;
        }
        .option-button.growth-heavy.selected {
            background-color: #e67e22 !important;
            border-color: #e67e22 !important;
            color: white !important;
        }
        .option-button.growth-severe.selected {
            background-color: #e74c3c !important;
            border-color: #e74c3c !important;
            color: white !important;
        }

        /* Growth level slider styles */
        .growth-slider-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .growth-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #27ae60 0%, #f39c12 33%, #e67e22 66%, #e74c3c 100%);
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .growth-slider:hover {
            opacity: 1;
        }

        .growth-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #345475;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .growth-slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #345475;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .growth-slider-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 12px;
            font-size: 12px;
            color: #2c3e50;
            text-align: center;
            line-height: 1.3;
        }

        .growth-slider-labels span {
            flex: 1;
        }

        .growth-slider-value {
            text-align: center;
            font-weight: 600;
            color: #345475;
            margin-top: 5px;
        }
        
        /* Wizard navigation styles */
        .wizard-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        
        .wizard-nav-btn {
            padding: 12px 24px;
            background-color: #345475;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .wizard-nav-btn:hover:not(:disabled) {
            background-color: #2a3f5f;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(52, 68, 117, 0.3);
        }
        
        .wizard-nav-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #wizardContent {
            min-height: 200px;
            padding: 20px 0;
        }
        
        .wizard-step {
            display: none;
        }
        
        .wizard-step.active {
            display: block;
            animation: wizardStepFade 0.3s ease-in-out;
        }
        
        @keyframes wizardStepFade {
            from {
                opacity: 0;
                transform: translateX(10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #345475;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background-color: white;
            /* Better for touch/gloved fingers */
            min-height: 48px;
            -webkit-appearance: none;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #345475;
            border-width: 2px;
            box-shadow: 0 0 0 4px rgba(52, 84, 117, 0.2);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .cancel-btn {
            padding: 14px 24px;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            font-size: 16px;
            min-height: 48px;
            min-width: 100px;
        }
        
        .cancel-btn:hover {
            background-color: #7f8c8d;
        }
        
        .submit-btn {
            padding: 14px 24px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            font-size: 16px;
            min-height: 48px;
            min-width: 100px;
        }
        
        .submit-btn:hover {
            background-color: #229954;
        }
        
        /* Boat details section */
        .boat-details {
            background: #ffffff;
            padding: 30px 0;
            margin-bottom: 30px;
            border-top: 1px solid #e0e0e0;
        }
        
        .boat-details h3 {
            color: #181818;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 400;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            color: #345475;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            border-color: #345475;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 84, 117, 0.1);
        }
        
        /* Pricing display section */
        .pricing-display {
            background: #ffffff;
            padding: 30px 0;
            margin-bottom: 30px;
            border-top: 1px solid #e0e0e0;
        }
        
        .pricing-display h3 {
            color: #181818;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 400;
        }
        
        /* Boat Configuration Section */
        .boat-config-section {
            background: #ffffff;
            padding: 30px 0;
            margin: 30px 0;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .boat-config-section h3 {
            color: #181818;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 400;
        }
        
        .config-group {
            margin-bottom: 25px;
        }
        
        .config-group label {
            display: block;
            font-weight: 500;
            color: #181818;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: normal;
        }
        
        .radio-option:hover {
            background: #e9ecef;
            border-color: #345475;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .radio-option input[type="radio"]:checked + span {
            font-weight: 600;
            color: #345475;
        }
        
        .radio-option input[type="radio"]:checked {
            accent-color: #345475;
        }
        
        .radio-option:has(input[type="radio"]:checked) {
            background: linear-gradient(to right, rgba(52, 84, 117, 0.1), rgba(52, 84, 117, 0.05));
            border-color: #345475;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-option:hover {
            background: #e9ecef;
            border-color: #345475;
        }
        
        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #345475;
        }
        
        .checkbox-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #345475;
        }
        
        .checkbox-option:has(input[type="checkbox"]:checked) {
            background: linear-gradient(to right, rgba(52, 84, 117, 0.1), rgba(52, 84, 117, 0.05));
            border-color: #345475;
        }
        
        /* Better formatted bullet points in price breakdown */
        .price-breakdown .breakdown-item {
            display: block;
            margin-left: 20px;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .price-breakdown .breakdown-detail {
            margin-left: 40px;
            font-size: 0.95em;
            color: #555;
        }
        
        .price-breakdown .breakdown-header {
            display: block;
            margin-top: 12px;
            margin-bottom: 8px;
            color: #181818;
        }
        
        .price-breakdown .breakdown-total-line {
            display: block;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }
        
        .price-breakdown .breakdown-line {
            display: block;
            margin-bottom: 5px;
        }
        
        /* Anode Charging Styles */
        .anode-section {
            display: none;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #345475;
        }
        
        .anode-section.active {
            display: block;
        }
        
        .daily-schedule {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .daily-schedule h3 {
            color: #181818;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
        }
        
        .schedule-date-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .schedule-date-selector input[type="date"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .boat-schedule-list {
            display: grid;
            gap: 10px;
        }
        
        .boat-schedule-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .boat-schedule-item:hover {
            border-color: #345475;
            box-shadow: 0 2px 8px rgba(52, 84, 117, 0.1);
        }
        
        .boat-schedule-item.selected {
            background: #345475;
            color: white;
            border-color: #345475;
        }
        
        .boat-schedule-item.completed {
            opacity: 0.6;
            background: #e8f5e9;
        }
        
        .boat-info {
            flex: 1;
        }
        
        .boat-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .boat-customer {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .boat-status {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            background: #27ae60;
            color: white;
        }
        
        .anode-selector {
            background: white;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .anode-selector h3 {
            color: #181818;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 500;
        }
        
        .anode-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .category-btn:hover {
            border-color: #345475;
        }
        
        .category-btn.active {
            background: #345475;
            color: white;
            border-color: #345475;
        }
        
        .anode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .anode-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .anode-item:hover {
            border-color: #345475;
            box-shadow: 0 2px 8px rgba(52, 84, 117, 0.1);
        }
        
        .anode-item.selected {
            background: rgba(52, 84, 117, 0.1);
            border-color: #345475;
        }
        
        .anode-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #181818;
        }
        
        .anode-price {
            font-size: 18px;
            color: #345475;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .anode-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-btn:hover {
            background: #f8f9fa;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        
        .anode-cart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .anode-cart h4 {
            margin-bottom: 15px;
            color: #181818;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .cart-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #345475;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .total-row.grand-total {
            font-size: 20px;
            font-weight: 600;
            color: #181818;
            margin-top: 10px;
        }
        
        .charge-anode-btn {
            width: 100%;
            padding: 18px;
            background: #345475;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .charge-anode-btn:hover {
            background: #2a3f5f;
        }
        
        .charge-anode-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Navigation Header with Hamburger Menu -->
    <header class="navigation-header">
        <div class="nav-container">
            <a href="https://www.sailorskills.com/" class="nav-logo">SAILOR SKILLS</a>
            <button class="nav-toggle" id="navToggle" aria-label="Menu">
                <span class="hamburger"></span>
                <span class="hamburger"></span>
                <span class="hamburger"></span>
            </button>
            <nav class="nav-links" id="navLinks">
                <a href="https://www.sailorskills.com/">HOME</a>
                <a href="https://www.sailorskills.com/training">TRAINING</a>
                <a href="https://www.sailorskills.com/diving">DIVING</a>
                <a href="https://www.sailorskills.com/detailing">DETAILING</a>
                <a href="https://www.sailorskills.com/deliveries">DELIVERIES</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Hero Header -->
        <div class="hero-header">
            <div class="admin-badge">ADMIN MODE</div>
            <div class="hero-content">
                <div class="hero-brand">SAILOR SKILLS</div>
                <h1 class="hero-service">ADMIN</h1>
                <div class="hero-tagline">CHARGE CUSTOMER</div>
                <div class="hero-subtitle">Use pricing calculator for existing customers</div>
            </div>
        </div>
    
    <!-- Add Payment Method Modal -->
    <div id="paymentMethodModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closePaymentMethodForm()">&times;</span>
            <h2>Add Payment Method</h2>
            <div id="paymentCustomerInfo" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <!-- Customer info will be populated here -->
            </div>
            <form id="payment-form" autocomplete="off" data-private="true">
                <div id="card-element" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                    <!-- Stripe card element will be mounted here -->
                </div>
                <div id="card-errors" role="alert" style="color: #e74c3c; margin-top: 10px; min-height: 20px;"></div>
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" onclick="closePaymentMethodForm()" class="cancel-btn">Cancel</button>
                    <button type="submit" id="submit-payment" class="submit-btn">Add Card</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Customer Modal -->
    <div id="newCustomerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeCreateCustomerForm()">&times;</span>
            <h2>Create New Customer</h2>
            <form id="newCustomerForm">
                <div class="form-group">
                    <label for="newCustomerName">Full Name *</label>
                    <input type="text" id="newCustomerName" name="name" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="newCustomerEmail">Email *</label>
                    <input type="email" id="newCustomerEmail" name="email" required placeholder="customer@example.com">
                </div>
                <div class="form-group">
                    <label for="newCustomerPhone">Phone</label>
                    <input type="tel" id="newCustomerPhone" name="phone" placeholder="+1 (555) 123-4567">
                </div>
                <div class="form-group">
                    <label for="newCustomerBoatName">Boat Name</label>
                    <input type="text" id="newCustomerBoatName" name="boat_name" placeholder="Serenity">
                </div>
                <div class="form-group">
                    <label for="newCustomerBoatLength">Boat Length (feet)</label>
                    <input type="number" id="newCustomerBoatLength" name="boat_length" min="20" max="100" placeholder="35">
                </div>
                <div class="form-group">
                    <label for="newCustomerBoatMake">Boat Make/Manufacturer</label>
                    <input type="text" id="newCustomerBoatMake" name="boat_make" placeholder="Catalina, Beneteau, etc.">
                </div>
                <div class="form-group">
                    <label for="newCustomerBoatModel">Boat Model</label>
                    <input type="text" id="newCustomerBoatModel" name="boat_model" placeholder="Oceanis 45, Hunter 36, etc.">
                </div>
                <div class="form-group">
                    <label for="newCustomerBoatYear">Boat Year</label>
                    <input type="number" id="newCustomerBoatYear" name="boat_year" min="1900" max="2025" placeholder="2018">
                </div>
                <div class="form-group">
                    <label for="newCustomerMarina">Marina</label>
                    <input type="text" id="newCustomerMarina" name="marina" placeholder="San Francisco Marina">
                </div>
                <div class="form-group">
                    <label for="newCustomerDock">Dock</label>
                    <input type="text" id="newCustomerDock" name="dock" placeholder="A, B, C, etc.">
                </div>
                <div class="form-group">
                    <label for="newCustomerSlip">Slip Number</label>
                    <input type="text" id="newCustomerSlip" name="slip" placeholder="42">
                </div>
                <div class="form-group">
                    <label for="newCustomerBoatType">Boat Type</label>
                    <input type="text" 
                           id="newCustomerBoatType" 
                           name="boat_type" 
                           placeholder="e.g., Sailboat, Powerboat, Catamaran">
                </div>
                <div class="form-group">
                    <label for="newCustomerHullMaterial">Hull Material</label>
                    <input type="text" 
                           id="newCustomerHullMaterial" 
                           name="hull_material" 
                           placeholder="e.g., Fiberglass, Aluminum, Steel">
                </div>
                <div class="form-group">
                    <label for="newCustomerNotes">Notes</label>
                    <textarea id="newCustomerNotes" name="description" rows="3" placeholder="Any additional notes about the customer or boat..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeCreateCustomerForm()" class="cancel-btn">Cancel</button>
                    <button type="submit" class="submit-btn">Create Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Selection Modal (for charging without pre-selected customer) -->
    <div id="customerSelectionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeCustomerSelectionModal()">&times;</span>
            <h2>Select or Enter Customer Details</h2>

            <div style="margin: 20px 0;">
                <!-- Tabs for selection method -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="selectExistingTab" class="tab-button active" onclick="showCustomerTab('existing')" style="flex: 1; padding: 10px; background: #345475; color: white; border: none; border-radius: 5px;">
                        Select Existing Customer
                    </button>
                    <button id="manualEntryTab" class="tab-button" onclick="showCustomerTab('manual')" style="flex: 1; padding: 10px; background: #e0e0e0; color: #333; border: none; border-radius: 5px;">
                        Enter Manual Details
                    </button>
                </div>

                <!-- Existing Customer Selection -->
                <div id="existingCustomerTab">
                    <input type="text"
                           id="modalCustomerSearch"
                           placeholder="Search customers..."
                           style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <div id="modalCustomerList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 5px; padding: 10px;">
                        <!-- Customer list will be populated here -->
                    </div>
                    <button onclick="proceedWithSelectedCustomer()" class="submit-btn" style="margin-top: 15px; width: 100%;">
                        Proceed with Selected Customer
                    </button>
                </div>

                <!-- Manual Entry -->
                <div id="manualEntryTab" style="display: none;">
                    <form id="manualCustomerForm">
                        <div class="form-group">
                            <label for="manualCustomerName">Customer Name *</label>
                            <input type="text" id="manualCustomerName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="manualCustomerEmail">Email</label>
                            <input type="email" id="manualCustomerEmail" placeholder="customer@example.com (optional)">
                        </div>
                        <div class="form-group">
                            <label for="manualCustomerPhone">Phone</label>
                            <input type="tel" id="manualCustomerPhone" placeholder="(555) 123-4567 (optional)">
                        </div>
                        <div class="form-group">
                            <label for="manualBoatName">Boat Name</label>
                            <input type="text" id="manualBoatName" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method *</label>
                            <select id="paymentMethod" required>
                                <option value="cash">Cash</option>
                                <option value="check">Check</option>
                                <option value="venmo">Venmo</option>
                                <option value="zelle">Zelle</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn" style="width: 100%;">
                            Proceed with Manual Entry
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Tools Section -->
    <div class="admin-tools-section" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px 0; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <div class="container" style="max-width: 1200px;">
            <h2 style="margin-bottom: 15px; color: #2c3e50; font-size: 18px; text-transform: uppercase; letter-spacing: 0.1em;">Admin Tools</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                <a href="/anode-manager.html" target="_blank" class="admin-tool-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 600; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.05em;">
                    <span style="font-size: 18px;">ðŸ“¦</span> Inventory Management
                </a>
                <a href="/diving.html" target="_blank" class="admin-tool-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, #0E7BA7 0%, #138FB5 100%); color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 600; box-shadow: 0 4px 15px rgba(14, 123, 167, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.05em;">
                    <span style="font-size: 18px;">ðŸ¤¿</span> Diving Calculator
                </a>
                <a href="/quote-viewer.html" target="_blank" class="admin-tool-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; border: none; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 600; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.05em;">
                    <span style="font-size: 18px;">ðŸ“„</span> Quote Viewer
                </a>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- Customer Selector Section -->
        <div class="customer-section">
            <h2 style="margin-bottom: 15px;">Select Customer</h2>
            <div class="customer-controls" style="margin-bottom: 15px;">
                <input type="text"
                       id="customerSearch"
                       class="customer-search-input"
                       placeholder="Search by name, email, or boat name..."
                       style="width: 100%; box-sizing: border-box;">
                <div style="display: flex; gap: 8px; justify-content: flex-start;">
                    <button onclick="searchCustomers()" class="customer-btn">Search</button>
                    <button onclick="loadRecentCustomers()" class="customer-btn">Show Recent</button>
                    <button onclick="showCreateCustomerForm()" class="customer-btn" style="background-color: #27ae60;">+ New Customer</button>
                </div>
            </div>
            <div id="customerList" class="customer-list" style="display: none;">
                <div class="no-customers">Loading customers...</div>
            </div>
            <div id="selectedCustomer" class="selected-customer-display">
                <strong>Selected Customer:</strong> 
                <span id="selectedCustomerInfo"></span>
            </div>
        </div>

        <!-- Service Selection -->
        <div class="service-selector">
            <h2>Select Service Type</h2>
            <div class="simple-service-buttons" id="simpleServiceButtons" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0;">
                <!-- Simple service buttons with emojis and colors -->
                <button onclick="if(window.selectServiceDirect) selectServiceDirect('recurring_cleaning')" class="simple-service-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #5B3A99 0%, #6B4A9E 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(91, 58, 153, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ðŸ”„ Recurring Cleaning</button>
                <button onclick="if(window.selectServiceDirect) selectServiceDirect('onetime_cleaning')" class="simple-service-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #1E5F8E 0%, #2471A3 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(30, 95, 142, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ðŸ§½ One-Time Cleaning</button>
                <button onclick="if(window.selectServiceDirect) selectServiceDirect('item_recovery')" class="simple-service-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #C73E79 0%, #D84361 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(199, 62, 121, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ðŸ” Item Recovery</button>
                <button onclick="if(window.selectServiceDirect) selectServiceDirect('underwater_inspection')" class="simple-service-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #0E7BA7 0%, #138FB5 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(14, 123, 167, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ðŸ¤¿ Underwater Inspection</button>
                <button onclick="if(window.selectServiceDirect) selectServiceDirect('propeller_service')" class="simple-service-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #D68910 0%, #E59E1B 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(214, 137, 16, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">âš™ï¸ Propeller Service</button>
                <button onclick="if(window.selectServiceDirect) selectServiceDirect('anodes_only')" class="simple-service-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #C0392B 0%, #E74C3C 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(192, 57, 43, 0.3); transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">âš¡ Anodes Only</button>
            </div>
            
            <!-- Service details container -->
            <div id="wizardContainer" style="display: none;">
                <div id="wizardContent"></div>
            </div>
        </div>
        
        <!-- Define selectServiceDirect and wizard functions immediately -->
        <script>
            // Stub for updateChargeSummary (will be overridden later)
            window.updateChargeSummary = function() {
                console.log('updateChargeSummary stub called - waiting for real implementation');
            };

            // Update pricing display in wizard
            window.updateWizardPricing = function() {
                const wizardCostBreakdown = document.getElementById('wizardCostBreakdown');
                const wizardTotalPrice = document.getElementById('wizardTotalPrice');
                const costBreakdown = document.getElementById('costBreakdown');
                const totalCostDisplay = document.getElementById('totalCostDisplay');

                if (wizardCostBreakdown && costBreakdown) {
                    // Use textContent for <pre> element, and format it nicely
                    const breakdown = costBreakdown.textContent || 'Calculating...';
                    wizardCostBreakdown.innerHTML = breakdown.replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢');
                }

                if (wizardTotalPrice && totalCostDisplay) {
                    const totalText = totalCostDisplay.textContent || '$0.00';
                    wizardTotalPrice.innerHTML = `<strong>Total: ${totalText}</strong>`;
                }
            }

            // Back to services function
            window.backToServices = function() {
                const serviceSelector = document.querySelector('.service-selector');
                const serviceHeading = serviceSelector ? serviceSelector.querySelector('h2') : null;
                const wizardContainer = document.getElementById('wizardContainer');
                const simpleButtons = document.getElementById('simpleServiceButtons');

                // Hide wizard but keep the structure
                if (wizardContainer) {
                    wizardContainer.style.display = 'none';
                    // Clear content but keep the wizardContent div
                    const wizardContent = document.getElementById('wizardContent');
                    if (wizardContent) {
                        wizardContent.innerHTML = '';
                    }
                }

                // Show simple service buttons
                if (simpleButtons) {
                    simpleButtons.style.display = 'flex';
                }

                // Show heading
                if (serviceHeading) {
                    serviceHeading.style.display = 'block';
                }

                // Reset selected service
                window.currentServiceKey = null;
                window.selectedServiceKey = null;

                // Update charge summary
                if (window.updateChargeSummary) {
                    window.updateChargeSummary();
                }
            }

            // Define wizard paint condition selection function
            window.selectWizardPaintCondition = function(value) {
                document.querySelectorAll('#wizardPaintConditionButtons .option-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                const selectedBtn = document.querySelector(`#wizardPaintConditionButtons [data-value="${value}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }
                const wizardInput = document.getElementById('wizardPaintCondition');
                if (wizardInput) {
                    wizardInput.value = value;
                }

                // Sync with main form
                const mainCondition = document.getElementById('actualPaintCondition');
                if (mainCondition) {
                    mainCondition.value = value;
                    if (window.selectPaintCondition) {
                        window.selectPaintCondition(value);
                    }
                }

                // Update pricing
                setTimeout(() => {
                    if (window.calculateCost) window.calculateCost();
                    if (window.updateWizardPricing) window.updateWizardPricing();
                    if (window.updateChargeSummary) window.updateChargeSummary();
                }, 100);
            };

            // Setup wizard growth level slider function
            window.setupWizardGrowthSlider = function() {
                const sliders = [
                    { slider: 'wizardGrowthLevelSlider', display: 'wizardGrowthSliderValue' },
                    { slider: 'wizardGrowthLevelSliderMain', display: 'wizardGrowthSliderValueMain' }
                ];

                sliders.forEach(({slider: sliderId, display: displayId}) => {
                    const sliderEl = document.getElementById(sliderId);
                    const displayEl = document.getElementById(displayId);

                    if (sliderEl) {
                        sliderEl.addEventListener('input', function() {
                            const sliderValue = parseInt(this.value);
                            let label, level, percentage;

                            // Map slider value to growth level and surcharge percentage
                            if (sliderValue === 0) {
                                label = 'Minimal';
                                level = 'minimal';
                                percentage = 0;
                            } else if (sliderValue <= 20) {
                                label = 'Minimal';
                                level = 'minimal';
                                percentage = 0;
                            } else if (sliderValue <= 35) {
                                label = 'Moderate';
                                level = 'moderate';
                                percentage = Math.round((sliderValue - 20) * 25 / 15);
                            } else if (sliderValue <= 60) {
                                label = 'Heavy';
                                level = 'heavy';
                                percentage = 25 + Math.round((sliderValue - 35) * 25 / 25);
                            } else {
                                label = 'Severe';
                                level = 'severe';
                                // Smooth increase from 50% to 200%
                                percentage = 50 + Math.round((sliderValue - 60) * 150 / 40);
                            }

                            const wizardInput = document.getElementById('wizardGrowthLevel');
                            if (wizardInput) {
                                wizardInput.value = level;
                                wizardInput.setAttribute('data-surcharge', percentage);
                            }
                            if (displayEl) {
                                displayEl.textContent = `${label} (${percentage}%)`;
                            }

                            // Sync with main form
                            const mainGrowth = document.getElementById('actualGrowthLevel');
                            if (mainGrowth) {
                                mainGrowth.value = level;
                                mainGrowth.setAttribute('data-surcharge', percentage);
                                const mainSlider = document.getElementById('growthLevelSlider');
                                if (mainSlider) {
                                    mainSlider.value = sliderValue;
                                    const mainDisplay = document.getElementById('growthSliderValue');
                                    if (mainDisplay) {
                                        mainDisplay.textContent = `${label} (${percentage}%)`;
                                    }
                                }
                            }

                            // Update pricing
                            setTimeout(() => {
                                if (window.calculateCost) window.calculateCost();
                                if (window.updateWizardPricing) window.updateWizardPricing();
                                if (window.updateChargeSummary) window.updateChargeSummary();
                            }, 100);
                        });
                    }
                });
            };

            // Initialize wizard sliders
            window.setupWizardGrowthSlider();

            window.selectServiceDirect = function(serviceKey) {
                console.log('Direct service selection:', serviceKey);

                // Update service state
                window.currentServiceKey = serviceKey;
                window.selectedServiceKey = serviceKey;

                // Update charge summary to enable button (with delay to ensure function is loaded)
                setTimeout(() => {
                    if (window.updateChargeSummary) {
                        window.updateChargeSummary();
                    }
                }, 100);
                
                // Hide the simple service buttons
                const simpleButtons = document.getElementById('simpleServiceButtons');
                if (simpleButtons) {
                    simpleButtons.style.display = 'none';
                }
                
                // Update the heading
                const serviceHeading = document.querySelector('.service-selector h2');
                if (serviceHeading) {
                    serviceHeading.style.display = 'none';
                }
                
                // Show the wizard container
                const wizardContainer = document.getElementById('wizardContainer');
                if (wizardContainer) {
                    wizardContainer.style.display = 'block';
                    
                    // Basic content for now
                    const wizardContent = document.getElementById('wizardContent');
                    if (wizardContent) {
                        const service = window.serviceData && window.serviceData[serviceKey];
                        const serviceName = service ? service.name : serviceKey;
                        
                        wizardContent.innerHTML = `
                            <div style="padding: 20px;">
                                <h2 style="margin-bottom: 20px;">${serviceName}</h2>
                                <p style="margin-bottom: 20px;">Service configuration will load here...</p>
                                <button onclick="if(window.backToServices) backToServices(); else location.reload();" 
                                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    â† Back to Services
                                </button>
                            </div>
                        `;
                        
                        // Call renderConsolidatedForm after a longer delay to ensure module script loads
                        const isCleaningService = serviceKey === 'onetime_cleaning' || serviceKey === 'recurring_cleaning';
                        // Wait for module script to load and override the stub
                        setTimeout(() => {
                            if (window.renderConsolidatedForm) {
                                console.log('Calling renderConsolidatedForm from selectServiceDirect');
                                window.renderConsolidatedForm(isCleaningService, serviceKey);
                            }
                        }, 1000);
                    }
                }
            };
            
            // Initialize anode catalog and cart
            window.anodeCatalog = window.anodeCatalog || [];
            window.anodeCart = window.anodeCart || [];
            window.currentCategory = 'all';
            
            // Define displayAnodeCatalog immediately
            window.displayAnodeCatalog = function() {
                const grid = document.getElementById('anodeGrid');
                if (!grid) {
                    console.error('Anode grid not found');
                    return;
                }
                
                // Display all anodes initially
                grid.innerHTML = '';
                window.anodeCatalog.forEach(anode => {
                    const anodeDiv = document.createElement('div');
                    anodeDiv.className = 'anode-item';
                    anodeDiv.dataset.category = anode.category;
                    
                    anodeDiv.innerHTML = `
                        <div class="anode-name">${anode.name}</div>
                        <div class="anode-id">ID: ${anode.boatzincs_id || anode.id}</div>
                        <div class="anode-price">$${anode.list_price.toFixed(2)}</div>
                        <div class="quantity-controls">
                            <button onclick="updateAnodeQuantity('${anode.boatzincs_id || anode.id}', -1)">-</button>
                            <span id="qty-${anode.boatzincs_id || anode.id}">0</span>
                            <button onclick="updateAnodeQuantity('${anode.boatzincs_id || anode.id}', 1)">+</button>
                        </div>
                    `;
                    
                    grid.appendChild(anodeDiv);
                });
                
                console.log(`Displayed ${window.anodeCatalog.length} anodes in grid`);
            };
            
            // Define updateAnodeQuantity for cart management
            window.updateAnodeQuantity = function(anodeId, change) {
                const anode = window.anodeCatalog.find(a => (a.boatzincs_id || a.id) === anodeId);
                if (!anode) return;
                
                // Find or create cart item
                let cartItem = window.anodeCart.find(item => item.id === anodeId);
                if (!cartItem && change > 0) {
                    cartItem = {
                        id: anodeId,
                        name: anode.name,
                        price: anode.list_price,
                        quantity: 0
                    };
                    window.anodeCart.push(cartItem);
                }
                
                if (cartItem) {
                    cartItem.quantity += change;
                    if (cartItem.quantity <= 0) {
                        window.anodeCart = window.anodeCart.filter(item => item.id !== anodeId);
                    }
                    
                    // Update display
                    const qtySpan = document.getElementById(`qty-${anodeId}`);
                    if (qtySpan) {
                        qtySpan.textContent = cartItem ? cartItem.quantity : 0;
                    }
                    
                    // Update cart display
                    updateCartDisplay();
                }
            };
            
            // Define filterAnodes for category filtering
            window.filterAnodes = function(category) {
                window.currentCategory = category;
                const allItems = document.querySelectorAll('.anode-item');
                
                allItems.forEach(item => {
                    if (category === 'all') {
                        item.style.display = 'block';
                    } else {
                        const itemCategory = item.dataset.category;
                        // Show items that match the category or related categories
                        if (category === 'shaft' && (itemCategory?.includes('shaft') || itemCategory === 'collar')) {
                            item.style.display = 'block';
                        } else if (itemCategory === category || itemCategory?.includes(category)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                });
                
                // Update active button styling
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target?.classList.add('active');
            };
            
            // Define updateCartDisplay
            window.updateCartDisplay = function() {
                const cartItems = document.getElementById('cartItems');
                const anodeTotal = document.getElementById('anodeTotal');
                
                if (cartItems) {
                    if (window.anodeCart.length === 0) {
                        cartItems.innerHTML = '<p style="color: #666;">No anodes selected</p>';
                    } else {
                        let html = '';
                        let total = 0;
                        
                        window.anodeCart.forEach(item => {
                            const itemTotal = item.price * item.quantity;
                            total += itemTotal;
                            html += `
                                <div style="padding: 8px; background: #f5f5f5; margin-bottom: 8px; border-radius: 4px;">
                                    <div style="font-weight: 600;">${item.name}</div>
                                    <div>Qty: ${item.quantity} Ã— $${item.price.toFixed(2)} = $${itemTotal.toFixed(2)}</div>
                                </div>
                            `;
                        });
                        
                        cartItems.innerHTML = html;
                        
                        // Calculate with tax and markup
                        const taxRate = parseFloat(document.getElementById('taxRate')?.value || 10.75) / 100;
                        const markupRate = parseFloat(document.getElementById('markupRate')?.value || 20) / 100;
                        const laborPerAnode = parseFloat(document.getElementById('laborCharge')?.value || 15);
                        const totalAnodes = window.anodeCart.reduce((sum, item) => sum + item.quantity, 0);
                        
                        const subtotal = total * (1 + markupRate);
                        const labor = totalAnodes * laborPerAnode;
                        const finalTotal = (subtotal + labor) * (1 + taxRate);
                        
                        if (anodeTotal) {
                            anodeTotal.textContent = `$${finalTotal.toFixed(2)}`;
                        }
                    }
                }
            };
            
            // Define loadAnodeCatalog immediately so it's available
            window.loadAnodeCatalog = async function() {
                try {
                    console.log('Loading anode catalog from /full-boatzincs-catalog.json');
                    let response = await fetch('/full-boatzincs-catalog.json');
                    if (response.ok) {
                        const data = await response.json();
                        // The JSON has an "anodes" property containing the array
                        window.anodeCatalog = data.anodes || data;
                        console.log(`Loaded ${window.anodeCatalog.length} anodes from catalog`);
                        window.displayAnodeCatalog();
                        window.updateCartDisplay();
                        return;
                    }
                    console.error('Failed to load anode catalog');
                } catch (error) {
                    console.error('Error loading anode catalog:', error);
                }
            };
            
            // Define toggleAnodeSection immediately so it's available when buttons are clicked
            window.toggleAnodeSection = function() {
                console.log('toggleAnodeSection called');
                const section = document.getElementById('anodeSection');
                if (!section) {
                    console.error('Anode section not found');
                    return;
                }
                
                // Toggle visibility
                if (section.style.display === 'none' || section.style.display === '') {
                    section.style.display = 'block';
                    section.classList.add('active');
                    
                    // Load anode catalog if not already loaded
                    if (!window.anodeCatalog || window.anodeCatalog.length === 0) {
                        console.log('Loading anode catalog...');
                        window.loadAnodeCatalog();
                    }
                    
                    // Scroll to the section
                    setTimeout(() => {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    section.style.display = 'none';
                    section.classList.remove('active');
                }
            };
            
            // Define renderConsolidatedForm here immediately - don't wait for module script
            window.renderConsolidatedForm = function(isCleaningService, serviceKey) {
                console.log('Immediate renderConsolidatedForm called for', serviceKey);
                const wizardContent = document.getElementById('wizardContent');
                if (!wizardContent) return;

                const service = window.serviceData ? window.serviceData[serviceKey] : null;
                const serviceName = service ? service.name : 'Service';
                const needsBoatLength = service && service.type === 'per_foot';

                // Build the form HTML
                let html = `
                    <div class="consolidated-form">
                        <div class="form-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #2c3e50;">${serviceName}</h2>
                            <button onclick="backToServices()" class="back-btn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                â† Back to Services
                            </button>
                        </div>

                        <div class="form-section" style="background: #f8f9fa; padding: 25px; border-radius: 12px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; margin-bottom: 20px; color: #2c3e50; font-size: 20px; font-weight: 600;">Boat Information</h3>
                            <div class="input-group" style="margin-bottom: 20px;">
                                <label for="wizardBoatName" style="display: block; margin-bottom: 8px; font-weight: 600;">Boat Name (optional)</label>
                                <input type="text" id="wizardBoatName" placeholder="Enter boat name"
                                       value="${document.getElementById('boatName')?.value || ''}"
                                       style="font-size: 18px; padding: 14px; width: 100%; border: 2px solid #ddd; border-radius: 8px;">
                            </div>`;

                // Only show boat length for per-foot services (cleaning services)
                if (needsBoatLength) {
                    html += `
                            <div class="input-group" style="margin-bottom: 20px;">
                                <label for="wizardBoatLength" style="display: block; margin-bottom: 8px; font-weight: 600;">Boat Length (feet)</label>
                                <input type="text" id="wizardBoatLength" placeholder="e.g., 35, 42, 50"
                                       value="${document.getElementById('boatLength')?.value || '35'}"
                                       style="font-size: 18px; padding: 14px; width: 100%; border: 2px solid #ddd; border-radius: 8px;">
                            </div>`;
                }

                html += `
                        </div>
                `;
                
                // Add condition fields for cleaning services
                if (isCleaningService) {
                    html += `
                        <div class="form-section" style="background: #f8f9fa; padding: 25px; border-radius: 12px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; margin-bottom: 20px; color: #2c3e50; font-size: 20px; font-weight: 600;">Current Condition</h3>
                            
                            <div class="input-group" style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Paint Condition</label>
                                <div class="option-button-group" id="wizardPaintConditionButtons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button type="button" class="option-button paint-excellent" data-value="excellent"
                                            onclick="selectWizardPaintCondition('excellent')">
                                        Excellent
                                    </button>
                                    <button type="button" class="option-button paint-good selected" data-value="good"
                                            onclick="selectWizardPaintCondition('good')">
                                        Good
                                    </button>
                                    <button type="button" class="option-button paint-fair" data-value="fair"
                                            onclick="selectWizardPaintCondition('fair')">
                                        Fair
                                    </button>
                                    <button type="button" class="option-button paint-poor" data-value="poor"
                                            onclick="selectWizardPaintCondition('poor')">
                                        Poor
                                    </button>
                                    <button type="button" class="option-button paint-missing" data-value="missing"
                                            onclick="selectWizardPaintCondition('missing')">
                                        Missing
                                    </button>
                                </div>
                                <input type="hidden" id="wizardPaintCondition" value="good">
                            </div>
                            
                            <div class="input-group">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Growth Level</label>
                                <div class="growth-slider-container">
                                    <input type="range" class="growth-slider" id="wizardGrowthLevelSliderMain" min="0" max="100" value="0" step="5">
                                    <div class="growth-slider-labels">
                                        <span>Minimal<br>0%</span>
                                        <span>Moderate<br>25%</span>
                                        <span>Heavy<br>50%</span>
                                        <span>Severe<br>200%</span>
                                    </div>
                                    <div class="growth-slider-value" id="wizardGrowthSliderValueMain">Minimal (0%)</div>
                                </div>
                                <input type="hidden" id="wizardGrowthLevel" value="minimal">
                            </div>
                        </div>
                    `;
                }

                // Add pricing display section for ALL services
                html += `
                    <div class="form-section" style="background: #e8f4fd; padding: 25px; border-radius: 12px; border: 2px solid #345475; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; margin-bottom: 15px; color: #2c3e50; font-size: 20px; font-weight: 600;">ðŸ’° Pricing Summary</h3>
                        <div id="wizardCostBreakdown" style="font-size: 16px; line-height: 1.8; color: #34495e; margin-bottom: 15px;">
                            Calculating...
                        </div>
                        <div id="wizardTotalPrice" style="font-size: 24px; font-weight: bold; color: #345475; padding-top: 15px; border-top: 2px solid #345475;">
                            Total: $0.00
                        </div>
                    </div>
                `;

                // Add anodes button
                const isAnodesOnly = serviceKey === 'anodes_only';
                html += `
                    <div class="form-section" style="text-align: center; margin-top: 20px; background: #f8f9fa; padding: 25px; border-radius: 12px; border: 1px solid #e0e0e0;">
                        <button onclick="if(window.toggleAnodeSection) window.toggleAnodeSection(); else console.error('toggleAnodeSection not defined');" 
                                class="customer-btn" 
                                style="background-color: #e67e22; font-size: 16px; padding: 12px 24px; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            âš“ ${isAnodesOnly ? 'Select Anodes' : 'Add Anodes to Service'}
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            ${isAnodesOnly ? 'Select zinc anodes for replacement ($150 minimum service fee)' : 'Optional: Add zinc anode replacement to this service'}
                        </p>
                    </div>
                `;
                
                html += '</div>';
                
                wizardContent.innerHTML = html;
                
                // Auto-show anodes for Anodes Only service
                if (isAnodesOnly) {
                    setTimeout(() => {
                        const anodeSection = document.getElementById('anode-section');
                        if (anodeSection) {
                            anodeSection.style.display = 'block';
                        }
                    }, 500);
                }
                
                // Update pricing and sync values
                setTimeout(() => {
                    // Attach event listeners to wizard buttons
                    document.querySelectorAll('#wizardPaintConditionButtons button').forEach(btn => {
                        btn.onclick = function() {
                            if (window.selectWizardPaintCondition) {
                                window.selectWizardPaintCondition(this.dataset.value);
                            }
                        };
                    });

                    // Initialize wizard growth slider
                    if (window.setupWizardGrowthSlider) {
                        window.setupWizardGrowthSlider();
                    }

                    // Add boat length sync event listener directly
                    const wizardBoatLengthInput = document.getElementById('wizardBoatLength');
                    if (wizardBoatLengthInput) {
                        wizardBoatLengthInput.addEventListener('input', function() {
                            const boatLengthHidden = document.getElementById('boatLength');
                            if (boatLengthHidden) {
                                boatLengthHidden.value = this.value;
                                console.log('Boat length synced to:', this.value);
                                if (window.calculateCost) {
                                    window.calculateCost();
                                    console.log('calculateCost called after boat length change');
                                }
                                if (window.updateWizardPricing) {
                                    window.updateWizardPricing();
                                    console.log('updateWizardPricing called after boat length change');
                                }
                            }
                        });
                    }

                    if (window.calculateCost) window.calculateCost();
                    setTimeout(() => {
                        if (window.updateWizardPricing) window.updateWizardPricing();
                        if (window.updateChargeSummary) window.updateChargeSummary();
                    }, 100);
                }, 100);
            };
        </script>
        
        <!-- Hidden compatibility elements -->
        <div style="display: none;">
            <div class="service-selection-grid" id="serviceButtons"></div>
            <p class="variable-info" id="servicePriceExplainer"></p>
        </div>
        
        <!-- Boat Configuration Section (removed - redundant with wizard) -->
        <div id="boatConfigSection" class="boat-config-section" style="display: none !important; /* PERMANENTLY HIDDEN - handled by wizard */">
            <h3>â›µ Boat Configuration</h3>
            
            <div class="config-group">
                <label>Boat Type</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="boat_type" value="sailboat" checked onchange="updateBoatConfig()">
                        <span>Sailboat</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="boat_type" value="powerboat" onchange="updateBoatConfig()">
                        <span>Powerboat (+25% surcharge)</span>
                    </label>
                </div>
            </div>
            
            <div class="config-group">
                <label>Hull Type</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="hull_type" value="monohull" checked onchange="updateBoatConfig()">
                        <span>Monohull</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="hull_type" value="catamaran" onchange="updateBoatConfig()">
                        <span>Catamaran (+25% surcharge)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="hull_type" value="trimaran" onchange="updateBoatConfig()">
                        <span>Trimaran (+50% surcharge)</span>
                    </label>
                </div>
            </div>
            
            <div class="config-group">
                <label>Engine Configuration</label>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" id="has_twin_engines" name="has_twin_engines" value="true" onchange="updateBoatConfig()">
                        <span>Twin engines (+10% surcharge)</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Hidden step elements for calculator compatibility -->
        <div style="display: none;">
            <div id="step-0" class="form-step active"></div>
            <div id="step-1" class="form-step">
                <!-- Removed redundant boat length input -->
            </div>
            <div id="step-2" class="form-step"></div>
            <div id="step-3" class="form-step"></div>
            <div id="step-4" class="form-step"></div>
            <div id="step-5" class="form-step">
                <!-- Hidden selects removed - using text inputs -->
            </div>
            <div id="step-6" class="form-step">
                <!-- Hidden selects removed - using text inputs -->
            </div>
            <div id="step-7" class="form-step">
                <input type="number" id="anodesToInstall" value="0">
            </div>
            <div id="step-8" class="result-section form-step">
                <div id="hiddenCostBreakdown" style="display: none;"></div>
                <div class="total-row">
                    <span class="total-label">Total:</span>
                    <span class="total-value" id="hiddenTotalCostDisplay">$0</span>
                </div>
            </div>
        </div>

        <!-- Anode Charging Section -->
        <div id="anodeSection" class="anode-section" style="display: none;">
            <h2>âš“ Anode Replacement Charging</h2>
            
            <!-- Pricing Settings -->
            <div class="pricing-settings" style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h3>Pricing Configuration</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 15px;">
                    <div>
                        <label for="taxRate" style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Tax Rate (%):</label>
                        <input type="number" id="taxRate" value="10.75" step="0.01" min="0" max="100" 
                               style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #345475; border-radius: 5px;"
                               onchange="updatePricing()">
                    </div>
                    <div>
                        <label for="markupRate" style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Markup (%):</label>
                        <input type="number" id="markupRate" value="20" step="0.1" min="0" max="200" 
                               style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #345475; border-radius: 5px;"
                               onchange="updatePricing()">
                    </div>
                    <div>
                        <label for="laborCharge" style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Labor per Anode ($):</label>
                        <input type="number" id="laborCharge" value="15" step="0.01" min="0" 
                               style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #345475; border-radius: 5px;"
                               onchange="updatePricing()">
                    </div>
                </div>
            </div>
            
            <!-- Daily Boat Schedule -->
            <div class="daily-schedule">
                <h3>Today's Service Schedule</h3>
                <div class="schedule-date-selector">
                    <input type="date" id="scheduleDate" value="">
                    <button onclick="loadDailySchedule()" class="customer-btn">Load Schedule</button>
                    <button onclick="uploadScheduleCSV()" class="customer-btn">Upload CSV</button>
                </div>
                <div id="boatScheduleList" class="boat-schedule-list">
                    <!-- Boats will be populated here -->
                </div>
            </div>
            
            <!-- Anode Selection Interface -->
            <div id="anodeSelector" class="anode-selector">
                <h3>Select Anodes for: <span id="selectedBoatName">[Select a boat above or choose anodes directly]</span></h3>
                
                <!-- Category Filters -->
                <div class="anode-categories">
                    <button class="category-btn active" onclick="filterAnodes('all')">All</button>
                    <button class="category-btn" onclick="filterAnodes('shaft')">Shaft</button>
                    <button class="category-btn" onclick="filterAnodes('hull')">Hull</button>
                    <button class="category-btn" onclick="filterAnodes('engine')">Engine</button>
                    <button class="category-btn" onclick="filterAnodes('propeller')">Propeller</button>
                    <button class="category-btn" onclick="filterAnodes('rudder')">Rudder/Trim</button>
                    <button class="category-btn" onclick="filterAnodes('collar')">Collar</button>
                    <button class="category-btn" onclick="filterAnodes('outboard')">Outboard</button>
                </div>
                
                <!-- Anode Grid -->
                <div id="anodeGrid" class="anode-grid">
                    <!-- Anodes will be populated here -->
                </div>
                
                <!-- Shopping Cart -->
                <div class="anode-cart">
                    <h4>Selected Anodes</h4>
                    <div id="cartItems">
                        <!-- Cart items will be populated here -->
                    </div>
                    <!-- Hidden elements for price calculation compatibility -->
                    <div style="display: none;">
                        <span id="anodeSubtotal">$0.00</span>
                        <span id="laborCount">0</span>
                        <span id="laborRate">15</span>
                        <span id="anodeLaborTotal">$0.00</span>
                        <span id="taxRateDisplay">10.75</span>
                        <span id="anodeTax">$0.00</span>
                        <span id="markupRateDisplay">20</span>
                        <span id="anodeMarkup">$0.00</span>
                        <span id="anodeTotal">$0.00</span>
                    </div>
                    <div style="display: none;">
                        <button id="chargeAnodeBtn" class="charge-anode-btn" onclick="chargeAnodes()" disabled>
                            ðŸ’³ Charge Customer
                        </button>
                        <button class="charge-anode-btn" style="background: #6c757d;" onclick="generateQuote()">
                            ðŸ“‹ Generate Quote
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boat Details Section (removed - redundant with wizard) -->
        <div class="boat-details" style="display: none !important; /* PERMANENTLY HIDDEN - handled by wizard */">
            <h3>Boat Details</h3>
            <div class="input-group">
                <label for="boatName">Boat Name</label>
                <input type="text" id="boatName" placeholder="Enter boat name (optional)">
            </div>
            
            <!-- Boat length now handled in wizard only -->
            <input type="hidden" id="boatLength" value="35">
            
            <div id="cleaningOptions">
                <div class="input-group">
                    <label>Paint Condition Found</label>
                    <div class="option-button-group" id="paintConditionButtons">
                        <button type="button" class="option-button paint-excellent" data-value="excellent" onclick="selectPaintCondition('excellent')">Excellent</button>
                        <button type="button" class="option-button paint-good selected" data-value="good" onclick="selectPaintCondition('good')">Good</button>
                        <button type="button" class="option-button paint-fair" data-value="fair" onclick="selectPaintCondition('fair')">Fair</button>
                        <button type="button" class="option-button paint-poor" data-value="poor" onclick="selectPaintCondition('poor')">Poor</button>
                        <button type="button" class="option-button paint-missing" data-value="missing" onclick="selectPaintCondition('missing')">Missing</button>
                    </div>
                    <input type="hidden" id="actualPaintCondition" value="good">
                </div>
                
                <div class="input-group">
                    <label>Growth Level Found</label>
                    <div class="growth-slider-container">
                        <input type="range" class="growth-slider" id="growthLevelSlider" min="0" max="100" value="0" step="5">
                        <div class="growth-slider-labels">
                            <span>Minimal<br>0%</span>
                            <span>Moderate<br>25%</span>
                            <span>Heavy<br>50%</span>
                            <span>Severe<br>200%</span>
                        </div>
                        <div class="growth-slider-value" id="growthSliderValue">Minimal (0%)</div>
                    </div>
                    <input type="hidden" id="actualGrowthLevel" value="minimal">
                </div>
            </div>
        </div>

        <!-- Hidden elements for price calculation compatibility -->
        <div style="display: none;">
            <pre id="costBreakdown"></pre>
            <span id="totalCostDisplay">$0</span>
        </div>

        <!-- Charge Summary Section -->
        <div class="charge-summary">
            <h3>ðŸ’³ Charge Summary</h3>
            <div class="charge-details" id="chargeDetails">
                <div style="text-align: center; color: #7f8c8d;">
                    Select a customer and configure service details
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="chargeButton" class="charge-button" onclick="chargeCustomer()" disabled>
                    ðŸ’³ Charge Customer
                </button>
                <button class="charge-button" style="background: #6c757d;" onclick="generateCombinedQuote()">
                    ðŸ“‹ Generate Quote
                </button>
            </div>
        </div>

        <!-- Result Display -->
        <div id="chargeResult" class="charge-result"></div>
    </div>

    <!-- Load Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script type="module">
        // Initialize Stripe
        const stripe = Stripe('pk_live_pri1IepedMvGQmLCFrV4kVzF'); // Your publishable key
        let elements = null;
        let cardElement = null;
        
        // Override selectService BEFORE script.js loads and populates buttons
        window.currentServiceKey = null;
        
        // Wizard state management - make these global so they're accessible across script blocks
        window.wizardCurrentStep = 0;
        window.wizardSteps = [];
        
        // Make transitionToDetailsForm available globally
        window.transitionToDetailsForm = function(serviceKey) {
            console.log('transitionToDetailsForm called for:', serviceKey);
            const serviceSelector = document.querySelector('.service-selector');
            // For admin page, use simpleServiceButtons instead of service-selection-grid
            let serviceGrid = document.getElementById('simpleServiceButtons');
            if (!serviceGrid) {
                serviceGrid = serviceSelector ? serviceSelector.querySelector('.service-selection-grid') : null;
            }
            const serviceHeading = serviceSelector ? serviceSelector.querySelector('h2') : null;
            const servicePriceExplainer = document.getElementById('servicePriceExplainer');
            const wizardContainer = document.getElementById('wizardContainer');
            const boatConfigSection = document.getElementById('boatConfigSection');
            const boatDetails = document.querySelector('.boat-details');
            const pricingDisplay = document.getElementById('pricingDisplay');
            
            // Hide the old boat config and pricing sections immediately
            if (boatConfigSection) boatConfigSection.style.display = 'none';
            if (boatDetails) boatDetails.style.display = 'none';
            if (pricingDisplay) pricingDisplay.style.display = 'none';
            if (servicePriceExplainer) servicePriceExplainer.style.display = 'none';
            
            // Determine service type for rendering
            const isCleaningService = serviceKey === 'onetime_cleaning' || serviceKey === 'recurring_cleaning';
            const service = window.serviceData[serviceKey];
            
            // Fade out service buttons and heading
            serviceGrid.classList.add('service-fade-container', 'fade-out');
            if (serviceHeading) {
                serviceHeading.classList.add('service-fade-container', 'fade-out');
            }
            
            setTimeout(() => {
                // Hide service grid and heading, show wizard
                serviceGrid.style.display = 'none';
                if (serviceHeading) {
                    serviceHeading.style.display = 'none';
                }
                wizardContainer.style.display = 'block';
                wizardContainer.classList.add('service-fade-container', 'fade-in');
                
                // Render consolidated form with service key
                renderConsolidatedForm(isCleaningService, serviceKey);
                
                // If "Anodes Only" service, automatically show anode section
                if (serviceKey === 'anodes_only') {
                    setTimeout(() => {
                        const anodeSection = document.getElementById('anode-section');
                        if (anodeSection) {
                            anodeSection.style.display = 'block';
                        }
                    }, 500);
                }
                
                // Scroll to the top of the service selector section
                setTimeout(() => {
                    serviceSelector.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }, 100);
                
                // Remove fade classes after animation
                setTimeout(() => {
                    wizardContainer.classList.remove('service-fade-container', 'fade-in');
                }, 600);
            }, 400);
        };
        
        // Store the original selectService that will be loaded from script.js
        let selectServiceOriginal = null;
        
        // Define our override function
        function selectServiceOverride(serviceKey) {
            console.log('Admin interface selectService:', serviceKey);
            console.log('Current service key:', window.currentServiceKey);
            console.log('Comparison:', window.currentServiceKey === serviceKey);
            
            // If clicking the same service twice, do fade transition
            if (window.currentServiceKey === serviceKey) {
                console.log('Same service clicked twice, triggering wizard transition');
                // Use our own transitionToDetailsForm
                if (typeof window.transitionToDetailsForm === 'function') {
                    window.transitionToDetailsForm(serviceKey);
                } else {
                    console.error('transitionToDetailsForm not yet defined');
                }
                return;
            }
            
            // Otherwise, handle selection
            window.currentServiceKey = serviceKey;
            window.selectedServiceKey = serviceKey;
            
            // Update UI - replicate the necessary parts
            document.querySelectorAll('.service-option').forEach(btn => {
                btn.classList.remove('selected', 'expanded');
            });
            
            // Select and expand the clicked button
            const selectedButton = document.querySelector(`.service-option[data-service-key="${serviceKey}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected', 'expanded');
                
                // Update button content to show description
                const service = window.serviceData ? window.serviceData[serviceKey] : null;
                if (service && service.description) {
                    selectedButton.innerHTML = '';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'service-title';
                    titleDiv.textContent = service.name;
                    selectedButton.appendChild(titleDiv);
                    
                    const descDiv = document.createElement('div');
                    descDiv.className = 'service-description';
                    descDiv.textContent = service.description;
                    selectedButton.appendChild(descDiv);
                    
                    const clickNote = document.createElement('div');
                    clickNote.className = 'service-click-note';
                    clickNote.textContent = 'Click again to select this service';
                    selectedButton.appendChild(clickNote);
                }
            }
            
            // Calculate cost if function exists
            if (window.calculateCost) {
                window.calculateCost();
            }
            
            // Update visibility
            setTimeout(() => {
                if (typeof updateBoatConfigVisibility === 'function') {
                    updateBoatConfigVisibility(serviceKey);
                }
            }, 50);
        }
        
        // Override window.selectService immediately
        Object.defineProperty(window, 'selectService', {
            get: function() {
                return selectServiceOverride;
            },
            set: function(value) {
                // Store the original when script.js tries to set it
                if (!selectServiceOriginal && value !== selectServiceOverride) {
                    selectServiceOriginal = value;
                    console.log('Stored original selectService from script.js');
                }
            },
            configurable: true
        });
    </script>
    <script src="script.js" type="module"></script>
    <script type="module">
        try {
            console.log('Module script starting execution');

            let selectedCustomer = null;
            let customers = [];

            console.log('Variables declared successfully');

            // Wait for script.js to load completely
            function initializePage() {
            // Make sure serviceButtons and servicePriceExplainer elements are available globally
            window.serviceButtons = document.getElementById('serviceButtons');
            window.servicePriceExplainer = document.getElementById('servicePriceExplainer');
            
            console.log('Initializing diving admin page...');
            console.log('serviceButtons element:', window.serviceButtons);
            console.log('populateServiceButtons function:', window.populateServiceButtons);
            console.log('serviceData:', window.serviceData);
            
            // Populate service buttons from script.js
            if (window.populateServiceButtons && window.serviceData) {
                console.log('Populating service buttons...');
                window.populateServiceButtons();
            } else {
                console.log('Waiting for script.js to load...');
                // Retry if not loaded yet
                setTimeout(initializePage, 100);
                return;
            }
            
            // Set up a watcher for service selection changes
            setInterval(() => {
                const serviceKey = window.selectedServiceKey || window.getSelectedServiceKey?.();
                updateBoatConfigVisibility(serviceKey);
            }, 100);
            
            // boatLength is now a hidden field that gets synced from wizardBoatLength
            
            document.getElementById('actualPaintCondition')?.addEventListener('change', function() {
                if (window.calculateCostDirect) {
                    window.calculateCostDirect();
                } else if (window.calculateCost) {
                    window.calculateCost();
                }
                updateChargeSummary();
            });
            
            document.getElementById('actualGrowthLevel')?.addEventListener('change', function() {
                if (window.calculateCostDirect) {
                    window.calculateCostDirect();
                } else if (window.calculateCost) {
                    window.calculateCost();
                }
                updateChargeSummary();
            });

            // Add enter key support for search
            const searchInput = document.getElementById('customerSearch');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchCustomers();
                    }
                });
            }
            
            // Initial calculations
            if (window.calculateCost) {
                window.calculateCost();
            }
            // Don't auto-load customers on page load
        }
        
        // Initialize on page load
        console.log('Adding DOMContentLoaded listener');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            initializePage();
        });

        // If DOM is already ready, initialize immediately
        if (document.readyState !== 'loading') {
            console.log('DOM already ready, initializing immediately');
            initializePage();
        }

        console.log('Checkpoint 1: After initializePage setup');

        // Load recent customers
        async function loadRecentCustomers() {
            const listEl = document.getElementById('customerList');
            listEl.style.display = 'block';
            listEl.innerHTML = '<div class="no-customers">Loading customers...</div>';
            
            try {
                const response = await fetch('http://localhost:3001/api/stripe-customers?limit=10');
                const data = await response.json();
                customers = data.customers || [];
                displayCustomers(customers);
            } catch (error) {
                console.error('Error loading customers:', error);
                listEl.innerHTML = '<div class="no-customers">Error loading customers. Check console.</div>';
            }
        }
        
        // Make functions globally available
        window.loadRecentCustomers = loadRecentCustomers;

        // Search customers
        async function searchCustomers() {
            const query = document.getElementById('customerSearch').value.trim();
            if (!query) {
                loadRecentCustomers();
                return;
            }

            const listEl = document.getElementById('customerList');
            listEl.style.display = 'block';
            listEl.innerHTML = '<div class="no-customers">Searching...</div>';

            try {
                const response = await fetch(`http://localhost:3001/api/stripe-customers?search=${encodeURIComponent(query)}`);
                const data = await response.json();
                customers = data.customers || [];
                displayCustomers(customers);
            } catch (error) {
                console.error('Error searching customers:', error);
                listEl.innerHTML = '<div class="no-customers">Error searching. Check console.</div>';
            }
        }
        
        // Function to show create customer form
        function showCreateCustomerForm() {
            const modal = document.getElementById('newCustomerModal');
            modal.style.display = 'flex';
            document.getElementById('newCustomerForm').reset();
        }
        
        // Function to close create customer form
        function closeCreateCustomerForm() {
            const modal = document.getElementById('newCustomerModal');
            modal.style.display = 'none';
        }
        
        // Handle new customer form submission
        const newCustomerForm = document.getElementById('newCustomerForm');
        if (newCustomerForm) {
            newCustomerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
            
            const formData = new FormData(this);
            const customerData = {
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                description: formData.get('description'),
                metadata: {
                    boat_name: formData.get('boat_name'),
                    boat_length: formData.get('boat_length'),
                    boat_make: formData.get('boat_make'),
                    boat_model: formData.get('boat_model'),
                    boat_year: formData.get('boat_year'),
                    boat_type: formData.get('boat_type'),
                    hull_material: formData.get('hull_material'),
                    marina: formData.get('marina'),
                    dock: formData.get('dock'),
                    slip: formData.get('slip')
                }
            };
            
            // Remove empty metadata fields
            Object.keys(customerData.metadata).forEach(key => {
                if (!customerData.metadata[key] || customerData.metadata[key] === '') {
                    delete customerData.metadata[key];
                }
            });
            
            // Remove empty phone if not provided
            if (!customerData.phone) {
                delete customerData.phone;
            }
            
            console.log('Submitting customer data:', customerData);
            
            try {
                const response = await fetch('http://localhost:3001/api/create-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (response.ok) {
                    alert(`Customer created successfully!\nCustomer ID: ${result.customer.id}`);
                    closeCreateCustomerForm();
                    
                    // Add the new customer to the list and select them
                    const newCustomer = {
                        id: result.customer.id,
                        name: result.customer.name,
                        email: result.customer.email,
                        boat_name: result.customer.metadata?.boat_name,
                        payment_method: null
                    };
                    
                    customers.unshift(newCustomer);
                    displayCustomers(customers);
                    selectCustomer(result.customer.id, { currentTarget: document.querySelector(`[onclick*="${result.customer.id}"]`) });
                } else {
                    alert('Error creating customer: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating customer:', error);
                alert('Failed to create customer. Please try again.');
            }
        });
        }
        
        // Function to show add payment method form
        async function showAddPaymentMethod(customerId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            // Find customer details
            const customer = customers.find(c => c.id === customerId) || selectedCustomer;
            if (!customer) {
                alert('Please select a customer first');
                return;
            }
            
            // Show modal
            const modal = document.getElementById('paymentMethodModal');
            modal.style.display = 'flex';
            
            // Display customer info
            document.getElementById('paymentCustomerInfo').innerHTML = `
                <div><strong>Adding payment method for:</strong></div>
                <div>${customer.name || 'Unnamed'} (${customer.email})</div>
            `;
            
            try {
                // Create setup intent
                const response = await fetch('http://localhost:3001/api/create-setup-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: customerId })
                });
                
                const { clientSecret } = await response.json();
                
                // Create Stripe Elements
                elements = stripe.elements();
                
                // Create and mount card element with autofill
                const style = {
                    base: {
                        fontSize: '16px',
                        color: '#32325d',
                        '::placeholder': {
                            color: '#aab7c4'
                        }
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a'
                    }
                };
                
                cardElement = elements.create('card', { 
                    style: style,
                    hidePostalCode: false, // Show zip code for better fraud prevention
                    // Disable autofill to prevent admin's own card from auto-populating
                    disableLink: true,
                    iconStyle: 'solid'
                });
                cardElement.mount('#card-element');
                
                // Handle card errors
                cardElement.on('change', function(event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
                // Store setup data for form submission
                window.currentSetupIntent = {
                    clientSecret: clientSecret,
                    customerId: customerId
                };
                
            } catch (error) {
                console.error('Error setting up payment form:', error);
                alert('Failed to initialize payment form. Please try again.');
                closePaymentMethodForm();
            }
        }
        
        // Close payment method form
        function closePaymentMethodForm() {
            const modal = document.getElementById('paymentMethodModal');
            modal.style.display = 'none';
            
            // Unmount card element
            if (cardElement) {
                cardElement.unmount();
                cardElement = null;
            }
            elements = null;
            window.currentSetupIntent = null;
        }
        
        // Handle payment form submission
        const paymentForm = document.getElementById('payment-form');
        if (paymentForm) {
            paymentForm.addEventListener('submit', async function(event) {
                event.preventDefault();
            
            if (!window.currentSetupIntent) {
                alert('Setup not initialized. Please try again.');
                return;
            }
            
            const submitButton = document.getElementById('submit-payment');
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';
            
            try {
                // Confirm the setup intent with Stripe
                const result = await stripe.confirmCardSetup(
                    window.currentSetupIntent.clientSecret,
                    {
                        payment_method: {
                            card: cardElement,
                        }
                    }
                );
                
                if (result.error) {
                    // Show error to customer
                    document.getElementById('card-errors').textContent = result.error.message;
                    submitButton.disabled = false;
                    submitButton.textContent = 'Add Card';
                } else {
                    // Payment method attached successfully
                    alert('Payment method added successfully!');
                    closePaymentMethodForm();
                    
                    // Refresh customer list to show new payment method
                    if (window.loadRecentCustomers) {
                        window.loadRecentCustomers();
                    }
                }
            } catch (error) {
                console.error('Error confirming setup:', error);
                alert('Failed to add payment method. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Add Card';
            }
            });
        }
        
        // Make functions globally available
        window.searchCustomers = searchCustomers;
        window.showCreateCustomerForm = showCreateCustomerForm;
        window.closeCreateCustomerForm = closeCreateCustomerForm;
        window.showAddPaymentMethod = showAddPaymentMethod;
        window.closePaymentMethodForm = closePaymentMethodForm;

        // Display customer list
        function displayCustomers(customerList) {
            const listEl = document.getElementById('customerList');
            
            if (!customerList || customerList.length === 0) {
                listEl.innerHTML = '<div class="no-customers">No customers found</div>';
                return;
            }

            listEl.innerHTML = customerList.map(customer => `
                <div class="customer-item" onclick="selectCustomer('${customer.id}', event)">
                    <div class="customer-name">${customer.name || 'Unnamed Customer'}</div>
                    <div class="customer-email">${customer.email}${customer.boat_name ? ' â€¢ Boat: ' + customer.boat_name : ''}</div>
                    <span class="customer-payment ${customer.payment_method ? 'has-card' : 'no-card'}">
                        ${customer.payment_method ? 
                            'âœ“ Card on file' : 
                            '<span onclick="showAddPaymentMethod(\'${customer.id}\', event)" style="cursor: pointer; text-decoration: underline;">+ Add Card</span>'}
                    </span>
                </div>
            `).join('');

            // Re-select if a customer was already selected
            if (selectedCustomer) {
                const selectedEl = document.querySelector(`[onclick*="${selectedCustomer.id}"]`);
                if (selectedEl) {
                    selectedEl.classList.add('selected');
                }
            }
        }

        // Select a customer
        function selectCustomer(customerId, event) {
            selectedCustomer = customers.find(c => c.id === customerId);
            
            if (!selectedCustomer) return;
            
            // Update UI
            document.querySelectorAll('.customer-item').forEach(el => {
                el.classList.remove('selected');
            });
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('selected');
            }
            
            // Show selected customer info
            const selectedDisplay = document.getElementById('selectedCustomer');
            selectedDisplay.classList.add('active');
            document.getElementById('selectedCustomerInfo').textContent = 
                `${selectedCustomer.name || 'Unnamed'} (${selectedCustomer.email}) - ${
                    selectedCustomer.payment_method ? 'Card ending in ' + selectedCustomer.payment_method.card.last4 : 'No card on file'
                }`;
            
            updateChargeSummary();
        }
        
        // Make selectCustomer globally available
        window.selectCustomer = selectCustomer;
        
        // Update boat configuration and recalculate
        function updateBoatConfig() {
            if (window.calculateCost) {
                window.calculateCost();
            }
            updateChargeSummary();
        }
        
        window.updateBoatConfig = updateBoatConfig;
        
        // Paint condition selection functions
        function selectPaintCondition(value) {
            document.querySelectorAll('#paintConditionButtons .option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            const targetBtn = document.querySelector(`#paintConditionButtons [data-value="${value}"]`);
            if (targetBtn) {
                targetBtn.classList.add('selected');
            }
            document.getElementById('actualPaintCondition').value = value;

            if (window.calculateCostDirect) {
                window.calculateCostDirect();
            }
            updateChargeSummary();
        }
        
        // Note: selectWizardPaintCondition is already defined in the earlier script block
        
        // Growth level selection functions
        function setupGrowthSlider() {
            const slider = document.getElementById('growthLevelSlider');
            const valueDisplay = document.getElementById('growthSliderValue');
            const hiddenInput = document.getElementById('actualGrowthLevel');

            if (slider) {
                slider.addEventListener('input', function() {
                    const sliderValue = parseInt(this.value);
                    let label, level, percentage;

                    // Map slider value to growth level and surcharge percentage
                    if (sliderValue === 0) {
                        label = 'Minimal';
                        level = 'minimal';
                        percentage = 0;
                    } else if (sliderValue <= 20) {
                        label = 'Minimal';
                        level = 'minimal';
                        percentage = 0;
                    } else if (sliderValue <= 35) {
                        label = 'Moderate';
                        level = 'moderate';
                        percentage = Math.round((sliderValue - 20) * 25 / 15);
                    } else if (sliderValue <= 60) {
                        label = 'Heavy';
                        level = 'heavy';
                        percentage = 25 + Math.round((sliderValue - 35) * 25 / 25);
                    } else {
                        label = 'Severe';
                        level = 'severe';
                        // Smooth increase from 50% to 200%
                        percentage = 50 + Math.round((sliderValue - 60) * 150 / 40);
                    }

                    hiddenInput.value = level;
                    hiddenInput.setAttribute('data-surcharge', percentage);
                    valueDisplay.textContent = `${label} (${percentage}%)`;

                    if (window.calculateCostDirect) {
                        window.calculateCostDirect();
                    }
                    updateChargeSummary();
                });
            }
        }

        // Initialize slider on load
        setupGrowthSlider();
        
        // Make functions globally available
        window.selectPaintCondition = selectPaintCondition;
        // Note: selectWizardPaintCondition is already defined in the earlier script block
        window.setupGrowthSlider = setupGrowthSlider;
        
        // Function to update boat config visibility (deprecated - handled by wizard now)
        function updateBoatConfigVisibility(serviceKey) {
            // Old sections are now permanently hidden - all handled by wizard
            // Keeping function for compatibility but it does nothing
            return;
            
            // Show cleaning options only for cleaning services
            if (cleaningOptions) {
                cleaningOptions.style.display = isCleaningService ? 'block' : 'none';
            }
        }
        
        // Note: currentServiceKey, wizardCurrentStep, wizardSteps and selectService override are defined in the earlier script block
        
        // Function to handle fade transition in admin interface with wizard
        window.transitionToDetailsForm = function(serviceKey) {
            console.log('transitionToDetailsForm called for:', serviceKey);
            const serviceSelector = document.querySelector('.service-selector');
            // For admin page, use simpleServiceButtons instead of service-selection-grid
            let serviceGrid = document.getElementById('simpleServiceButtons');
            if (!serviceGrid) {
                serviceGrid = serviceSelector ? serviceSelector.querySelector('.service-selection-grid') : null;
            }
            const serviceHeading = serviceSelector ? serviceSelector.querySelector('h2') : null;
            const servicePriceExplainer = document.getElementById('servicePriceExplainer');
            const wizardContainer = document.getElementById('wizardContainer');
            const boatConfigSection = document.getElementById('boatConfigSection');
            const boatDetails = document.querySelector('.boat-details');
            const pricingDisplay = document.getElementById('pricingDisplay');
            
            // Hide the old boat config and pricing sections immediately
            if (boatConfigSection) boatConfigSection.style.display = 'none';
            if (boatDetails) boatDetails.style.display = 'none';
            if (pricingDisplay) pricingDisplay.style.display = 'none';
            if (servicePriceExplainer) servicePriceExplainer.style.display = 'none';
            
            // Determine service type for rendering
            const isCleaningService = serviceKey === 'onetime_cleaning' || serviceKey === 'recurring_cleaning';
            const service = window.serviceData[serviceKey];
            
            // Fade out service buttons and heading
            serviceGrid.classList.add('service-fade-container', 'fade-out');
            if (serviceHeading) {
                serviceHeading.classList.add('service-fade-container', 'fade-out');
            }
            
            setTimeout(() => {
                // Hide service grid and heading, show wizard
                serviceGrid.style.display = 'none';
                if (serviceHeading) {
                    serviceHeading.style.display = 'none';
                }
                wizardContainer.style.display = 'block';
                wizardContainer.classList.add('service-fade-container', 'fade-in');
                
                // Render consolidated form with service key
                renderConsolidatedForm(isCleaningService, serviceKey);
                
                // If "Anodes Only" service, automatically show anode section
                if (serviceKey === 'anodes_only') {
                    setTimeout(() => {
                        const anodeSection = document.getElementById('anode-section');
                        if (anodeSection) {
                            anodeSection.style.display = 'block';
                        }
                    }, 500);
                }
                
                // Scroll to the top of the service selector section
                setTimeout(() => {
                    serviceSelector.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }, 100);
                
                // Remove fade classes after animation
                setTimeout(() => {
                    wizardContainer.classList.remove('service-fade-container', 'fade-in');
                }, 600);
            }, 400);
        }
        
        // Old wizard step functions removed - replaced by renderConsolidatedForm
        
        // Render consolidated form (all fields in one view)
        console.log('Defining full renderConsolidatedForm function');
        window.renderConsolidatedForm = function(isCleaningService, serviceKey) {
            console.log('Full renderConsolidatedForm called for', serviceKey);
            const wizardContent = document.getElementById('wizardContent');
            const service = window.serviceData ? window.serviceData[serviceKey] : null;
            const serviceName = service ? service.name : 'Service';
            
            // Determine which fields are needed based on service
            const needsBoatConfig = isCleaningService;
            const needsPaintGrowth = isCleaningService;
            
            // For other services, just need basic boat info
            const isItemRecovery = serviceKey === 'item_recovery';
            const isUnderwaterInspection = serviceKey === 'underwater_inspection';
            const isPropellerService = serviceKey === 'propeller_service';
            const isAnodesOnly = serviceKey === 'anodes_only';
            
            // Underwater inspection only needs hull type (for pricing)
            const needsHullTypeOnly = isUnderwaterInspection;
            
            // Clear any existing content to prevent duplication
            wizardContent.innerHTML = '';
            
            // Build consolidated form HTML
            let formHTML = '<div class="consolidated-form">';
            
            // Add header with service name and back button
            formHTML += `
                <div class="form-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #2c3e50;">${serviceName}</h2>
                    <button onclick="backToServices()" class="back-btn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                        â† Back to Services
                    </button>
                </div>
            `;
            
            // Check if service needs boat length (per-foot services)
            const needsBoatLength = service && service.type === 'per_foot';
            
            // Always include boat information section
            formHTML += `
                <div class="form-section">
                    <h3>Boat Information</h3>
                    <div class="input-group">
                        <label for="wizardBoatName">Boat Name</label>
                        <input type="text" id="wizardBoatName" placeholder="Enter boat name (optional)" 
                               value="${document.getElementById('boatName')?.value || ''}" 
                               style="font-size: 18px; padding: 14px; width: 100%; border: 2px solid #ddd; border-radius: 8px;">
                    </div>`;
            
            // Only show boat length for per-foot services
            if (needsBoatLength) {
                formHTML += `
                    <div class="input-group">
                        <label for="wizardBoatLength">Boat Length (feet)</label>
                        <input type="text" id="wizardBoatLength" placeholder="e.g., 35, 42, 50"
                               value="${document.getElementById('boatLength')?.value || '35'}"
                               style="font-size: 18px; padding: 14px; width: 100%; border: 2px solid #ddd; border-radius: 8px;">
                    </div>`;
            }
            
            formHTML += `
                </div>
            `;
            
            // Add special hull type section for underwater inspection
            if (needsHullTypeOnly) {
                formHTML += `
                    <div class="form-section">
                        <h3>Hull Configuration</h3>
                        
                        <!-- Hull Type -->
                        <div class="input-group">
                            <label>Number of Hulls</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="wizard_hull_type" value="monohull" checked>
                                    <span>Monohull</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="wizard_hull_type" value="catamaran">
                                    <span>Catamaran (2 hulls)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="wizard_hull_type" value="trimaran">
                                    <span>Trimaran (3 hulls)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add cleaning-specific fields
            else if (isCleaningService) {
                formHTML += `
                    <div class="form-section">
                        <h3>Boat Configuration</h3>
                        
                        <!-- Boat Type -->
                        <div class="input-group">
                            <label>Boat Type</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="wizard_boat_type" value="sailboat" checked>
                                    <span>Sailboat</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="wizard_boat_type" value="powerboat">
                                    <span>Powerboat (+25% surcharge)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Hull Type -->
                        <div class="input-group">
                            <label>Hull Type</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="wizard_hull_type" value="monohull" checked>
                                    <span>Monohull</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="wizard_hull_type" value="catamaran">
                                    <span>Catamaran (+25% surcharge)</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="wizard_hull_type" value="trimaran">
                                    <span>Trimaran (+25% surcharge)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Engine Configuration -->
                        <div class="input-group">
                            <label>Engine Configuration</label>
                            <div class="checkbox-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="wizard_twin_engines" name="wizard_twin_engines">
                                    <span>Twin engines (+10% surcharge)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Current Condition</h3>
                        
                        <!-- Paint Condition -->
                        <div class="input-group">
                            <label>Paint Condition</label>
                            <div class="option-button-group" id="wizardPaintConditionButtons">
                                <button type="button" class="option-button paint-excellent" data-value="excellent" onclick="selectWizardPaintCondition('excellent')">Excellent</button>
                                <button type="button" class="option-button paint-good selected" data-value="good" onclick="selectWizardPaintCondition('good')">Good</button>
                                <button type="button" class="option-button paint-fair" data-value="fair" onclick="selectWizardPaintCondition('fair')">Fair</button>
                                <button type="button" class="option-button paint-poor" data-value="poor" onclick="selectWizardPaintCondition('poor')">Poor</button>
                                <button type="button" class="option-button paint-missing" data-value="missing" onclick="selectWizardPaintCondition('missing')">Missing</button>
                            </div>
                            <input type="hidden" id="wizardPaintCondition" value="good">
                        </div>
                        
                        <!-- Growth Level -->
                        <div class="input-group">
                            <label>Growth Level</label>
                            <div class="growth-slider-container">
                                <input type="range" class="growth-slider" id="wizardGrowthLevelSlider" min="0" max="100" value="0" step="5">
                                <div class="growth-slider-labels">
                                    <span>Minimal<br>0%</span>
                                    <span>Moderate<br>25%</span>
                                    <span>Heavy<br>50%</span>
                                    <span>Severe<br>200%</span>
                                </div>
                                <div class="growth-slider-value" id="wizardGrowthSliderValue">Minimal (0%)</div>
                            </div>
                            <input type="hidden" id="wizardGrowthLevel" value="minimal">
                        </div>
                    </div>
                `;
            }
            
            // Add the "Add Anodes" button after Current Condition
            // For "Anodes Only" service, show different message and auto-open
            if (isAnodesOnly) {
                formHTML += `
                    <div class="form-section" style="text-align: center; margin-top: 20px;">
                        <button onclick="toggleAnodeSection()" class="customer-btn" style="background-color: #e67e22; font-size: 16px; padding: 12px 24px;">
                            âš“ Select Anodes
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Select zinc anodes for replacement ($150 minimum service fee)
                        </p>
                    </div>
                `;
            } else {
                formHTML += `
                    <div class="form-section" style="text-align: center; margin-top: 20px;">
                        <button onclick="toggleAnodeSection()" class="customer-btn" style="background-color: #e67e22; font-size: 16px; padding: 12px 24px;">
                            âš“ Add Anodes to Service
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Optional: Add zinc anode replacement to this service
                        </p>
                    </div>
                `;
            }
            
            formHTML += '</div>';
            
            // Update content
            wizardContent.innerHTML = formHTML;
            wizardContent.className = 'consolidated-form-container active';
            
            // Add CSS for form sections if not already added
            if (!document.getElementById('consolidatedFormStyles')) {
                const style = document.createElement('style');
                style.id = 'consolidatedFormStyles';
                style.textContent = `
                    .consolidated-form {
                        display: flex;
                        flex-direction: column;
                        gap: 25px;
                    }
                    .form-section {
                        background: #f8f9fa;
                        padding: 25px;
                        border-radius: 12px;
                        border: 1px solid #e0e0e0;
                    }
                    .form-section h3 {
                        margin-top: 0;
                        margin-bottom: 20px;
                        color: #2c3e50;
                        font-size: 20px;
                        font-weight: 600;
                    }
                    .form-section .input-group {
                        margin-bottom: 20px;
                    }
                    .form-section .input-group:last-child {
                        margin-bottom: 0;
                    }
                    .consolidated-form-container {
                        padding: 20px 0;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Ensure boat length has a default value if not set
            const boatLengthHidden = document.getElementById('boatLength');
            if (boatLengthHidden && !boatLengthHidden.value) {
                boatLengthHidden.value = '35';
            }

            // Sync values with hidden inputs and calculate price - needs delay for DOM to be ready
            setTimeout(() => {
                syncWizardValues();

                console.log('Initial calculation on wizard load');
                if (window.calculateCost) {
                    window.calculateCost();
                    console.log('calculateCost called on wizard initialization');
                }
                if (window.updateWizardPricing) {
                    window.updateWizardPricing();
                    console.log('updateWizardPricing called on wizard initialization');
                }
            }, 100);
        }

        // Sync wizard values with hidden form inputs
        function syncWizardValues() {
            // Sync boat name
            const wizardBoatName = document.getElementById('wizardBoatName');
            if (wizardBoatName) {
                wizardBoatName.addEventListener('input', function() {
                    const boatName = document.getElementById('boatName');
                    if (boatName) boatName.value = this.value;
                });
            }
            
            // Sync boat length (only if it exists for per-foot services)
            const wizardBoatLength = document.getElementById('wizardBoatLength');
            if (wizardBoatLength) {
                // Set initial value from hidden input
                const boatLength = document.getElementById('boatLength');
                if (boatLength && boatLength.value) {
                    wizardBoatLength.value = boatLength.value;
                }

                wizardBoatLength.addEventListener('input', function() {
                    const boatLength = document.getElementById('boatLength');
                    if (boatLength) {
                        boatLength.value = this.value;
                        console.log('Boat length synced to:', this.value);

                        // Trigger calculations immediately
                        if (window.calculateCost) {
                            window.calculateCost();
                            console.log('calculateCost called after boat length change');
                        }
                        if (window.updateChargeSummary) {
                            window.updateChargeSummary();
                        }
                        if (window.updateWizardPricing) {
                            window.updateWizardPricing();
                            console.log('updateWizardPricing called after boat length change');
                        }
                    }
                });
            } else {
                // For flat rate services, set boat length to 0 or a default
                const boatLength = document.getElementById('boatLength');
                if (boatLength) {
                    boatLength.value = '0';
                }
            }
            
            // Sync boat type
            const wizardBoatTypes = document.querySelectorAll('input[name="wizard_boat_type"]');
            wizardBoatTypes.forEach(radio => {
                radio.addEventListener('change', function() {
                    const hiddenBoatType = document.querySelector(`input[name="boat_type"][value="${this.value}"]`);
                    if (hiddenBoatType) {
                        hiddenBoatType.checked = true;
                        if (window.calculateCost) window.calculateCost();
                        updateChargeSummary();
                        updateWizardPricing();
                    }
                });
            });
            
            // Sync hull type
            const wizardHullTypes = document.querySelectorAll('input[name="wizard_hull_type"]');
            wizardHullTypes.forEach(radio => {
                radio.addEventListener('change', function() {
                    const hiddenHullType = document.querySelector(`input[name="hull_type"][value="${this.value}"]`);
                    if (hiddenHullType) {
                        hiddenHullType.checked = true;
                        if (window.calculateCost) window.calculateCost();
                        updateChargeSummary();
                        updateWizardPricing();
                    }
                });
            });
            
            // Sync twin engines
            const wizardTwinEngines = document.getElementById('wizard_twin_engines');
            if (wizardTwinEngines) {
                wizardTwinEngines.addEventListener('change', function() {
                    const hiddenTwinEngines = document.getElementById('has_twin_engines');
                    if (hiddenTwinEngines) {
                        hiddenTwinEngines.checked = this.checked;
                        if (window.calculateCost) window.calculateCost();
                        updateChargeSummary();
                        updateWizardPricing();
                    }
                });
            }
            
            // Sync paint condition value to hidden input
            const wizardPaintCondition = document.getElementById('wizardPaintCondition');
            if (wizardPaintCondition) {
                // Set initial value
                const paintConditionHidden = document.getElementById('paint_condition');
                if (paintConditionHidden) {
                    paintConditionHidden.value = wizardPaintCondition.value;
                }
                
                // Watch for changes (via MutationObserver since it's updated programmatically)
                const observer = new MutationObserver(function() {
                    if (paintConditionHidden) {
                        paintConditionHidden.value = wizardPaintCondition.value;
                    }
                });
                observer.observe(wizardPaintCondition, { attributes: true, attributeFilter: ['value'] });
            }
            
            // Sync growth level value to hidden input  
            const wizardGrowthLevel = document.getElementById('wizardGrowthLevel');
            if (wizardGrowthLevel) {
                // Set initial value
                const growthLevelHidden = document.getElementById('growth_level');
                if (growthLevelHidden) {
                    growthLevelHidden.value = wizardGrowthLevel.value;
                }
                
                // Watch for changes (via MutationObserver since it's updated programmatically)
                const observer = new MutationObserver(function() {
                    if (growthLevelHidden) {
                        growthLevelHidden.value = wizardGrowthLevel.value;
                    }
                });
                observer.observe(wizardGrowthLevel, { attributes: true, attributeFilter: ['value'] });
            }
        }
        
        // Wizard navigation functions (no longer needed with consolidated form)
        /*
        window.wizardNext = function() {
            if (window.wizardCurrentStep < window.wizardSteps.length - 1) {
                window.wizardCurrentStep++;
                renderWizardStep();
            } else {
                // Complete wizard - show all sections
                completeWizard();
            }
        };
        
        window.wizardPrevious = function() {
            if (window.wizardCurrentStep > 0) {
                window.wizardCurrentStep--;
                renderWizardStep();
            }
        };
        */
        
        // Complete wizard and show pricing
        function completeWizard() {
            const wizardContainer = document.getElementById('wizardContainer');
            const serviceSelector = document.querySelector('.service-selector');
            // For admin page, use simpleServiceButtons instead of service-selection-grid
            let serviceGrid = document.getElementById('simpleServiceButtons');
            if (!serviceGrid) {
                serviceGrid = serviceSelector ? serviceSelector.querySelector('.service-selection-grid') : null;
            }
            const serviceHeading = serviceSelector.querySelector('h2');
            const servicePriceExplainer = document.getElementById('servicePriceExplainer');
            const pricingDisplay = document.getElementById('pricingDisplay');
            const boatDetails = document.querySelector('.boat-details');
            const boatConfig = document.getElementById('boatConfigSection');
            
            // Hide wizard with fade out
            wizardContainer.classList.add('fade-out');
            
            setTimeout(() => {
                wizardContainer.style.display = 'none';
                
                // Show service grid and heading again
                if (serviceHeading) {
                    serviceHeading.style.display = 'block';
                    serviceHeading.classList.add('service-fade-container', 'fade-in');
                }
                serviceGrid.style.display = 'grid';
                serviceGrid.classList.add('service-fade-container', 'fade-in');
                
                // Show pricing and summary
                if (boatDetails) {
                    boatDetails.style.display = 'block';
                    boatDetails.classList.add('service-fade-container', 'fade-in');
                }
                
                if (pricingDisplay) {
                    pricingDisplay.style.display = 'block';
                    pricingDisplay.classList.add('service-fade-container', 'fade-in');
                }
                
                // Calculate and update
                if (window.calculateCost) window.calculateCost();
                updateChargeSummary();
                
                // Scroll to pricing
                if (pricingDisplay) {
                    pricingDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Remove fade classes after animation
                setTimeout(() => {
                    if (serviceHeading) serviceHeading.classList.remove('service-fade-container', 'fade-in');
                    serviceGrid.classList.remove('service-fade-container', 'fade-in');
                }, 600);
            }, 400);
        }
        
        // Make transitionToDetailsForm globally available
        window.transitionToDetailsForm = transitionToDetailsForm;
        
        // Function to go back to service selection
        function backToServices() {
            const serviceSelector = document.querySelector('.service-selector');
            const serviceHeading = serviceSelector.querySelector('h2');
            const wizardContainer = document.getElementById('wizardContainer');
            const simpleButtons = document.getElementById('simpleServiceButtons');
            
            // Hide wizard
            wizardContainer.style.display = 'none';
            wizardContainer.innerHTML = '';
            
            // Show simple service buttons
            if (simpleButtons) {
                simpleButtons.style.display = 'flex';
            }
            
            // Show heading
            if (serviceHeading) {
                serviceHeading.style.display = 'block';
            }
            
            // Reset selected service
            window.currentServiceKey = null;
            window.selectedServiceKey = null;
            
            // Update charge summary
            if (typeof updateChargeSummary === 'function') {
                updateChargeSummary();
            }
        }
        
        // Make backToServices globally available
        window.backToServices = backToServices;
        
        // Direct service selection (skips the two-click behavior)
        window.selectServiceDirect = function(serviceKey) {
            console.log('Direct service selection:', serviceKey);

            // Update service state
            window.currentServiceKey = serviceKey;
            window.selectedServiceKey = serviceKey;

            // Update charge summary to enable button (with delay to ensure function is loaded)
            setTimeout(() => {
                if (window.updateChargeSummary) {
                    window.updateChargeSummary();
                }
            }, 100);
            
            // Use the existing transitionToDetailsForm function if available
            if (typeof window.transitionToDetailsForm === 'function') {
                window.transitionToDetailsForm(serviceKey);
            } else {
                // Fallback: manually show the form
                console.log('Using fallback transition');
                
                // Hide the simple service buttons
                const simpleButtons = document.getElementById('simpleServiceButtons');
                if (simpleButtons) {
                    simpleButtons.style.display = 'none';
                }
                
                // Update the heading
                const serviceHeading = document.querySelector('.service-selector h2');
                if (serviceHeading) {
                    serviceHeading.style.display = 'none';
                }
                
                // Show the wizard container
                const wizardContainer = document.getElementById('wizardContainer');
                if (wizardContainer) {
                    wizardContainer.style.display = 'block';
                    
                    // Try to render the form if function exists
                    const isCleaningService = serviceKey === 'onetime_cleaning' || serviceKey === 'recurring_cleaning';
                    if (typeof window.renderConsolidatedForm === 'function') {
                        window.renderConsolidatedForm(isCleaningService, serviceKey);
                    } else {
                        // Basic fallback content
                        const wizardContent = document.getElementById('wizardContent');
                        if (wizardContent) {
                            wizardContent.innerHTML = `
                                <div style="padding: 20px;">
                                    <h3>Loading service details...</h3>
                                    <p>Service: ${serviceKey}</p>
                                    <button onclick="backToServices()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px;">
                                        â† Back to Services
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    // Auto-show anode section for "Anodes Only" service
                    if (serviceKey === 'anodes_only') {
                        setTimeout(() => {
                            const anodeSection = document.getElementById('anode-section');
                            if (anodeSection) {
                                anodeSection.style.display = 'block';
                            }
                        }, 500);
                    }
                    
                    // Update charge summary if function exists
                    if (typeof window.updateChargeSummary === 'function') {
                        window.updateChargeSummary();
                    }
                }
            }
        };
        
        // Wait for buttons to be created and override their handlers
        setTimeout(() => {
            const serviceButtons = document.querySelectorAll('.service-option');
            serviceButtons.forEach(button => {
                // Remove the old event listener by cloning
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // Add our custom click handler
                newButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const serviceKey = this.dataset.serviceKey;
                    console.log('Admin interface button clicked:', serviceKey);
                    
                    // Check if same service clicked twice
                    if (window.currentServiceKey === serviceKey) {
                        console.log('Same service clicked twice, triggering wizard');
                        transitionToDetailsForm(serviceKey);
                    } else {
                        // First click - expand button
                        window.currentServiceKey = serviceKey;
                        window.selectedServiceKey = serviceKey;
                        
                        // Update UI
                        document.querySelectorAll('.service-option').forEach(btn => {
                            btn.classList.remove('selected', 'expanded');
                        });
                        
                        this.classList.add('selected', 'expanded');
                        
                        // Update button content
                        const service = window.serviceData[serviceKey];
                        if (service && service.description) {
                            this.innerHTML = '';
                            
                            const titleDiv = document.createElement('div');
                            titleDiv.className = 'service-title';
                            titleDiv.textContent = service.name;
                            this.appendChild(titleDiv);
                            
                            const descDiv = document.createElement('div');
                            descDiv.className = 'service-description';
                            descDiv.textContent = service.description;
                            this.appendChild(descDiv);
                            
                            const clickNote = document.createElement('div');
                            clickNote.className = 'service-click-note';
                            clickNote.textContent = 'Click again to select this service';
                            this.appendChild(clickNote);
                        }
                        
                        // Calculate cost
                        if (window.calculateCost) {
                            window.calculateCost();
                        }
                        
                        // Update visibility
                        setTimeout(() => {
                            if (typeof updateBoatConfigVisibility === 'function') {
                                updateBoatConfigVisibility(serviceKey);
                            }
                        }, 50);
                    }
                });
            });
            console.log('Replaced click handlers for', serviceButtons.length, 'service buttons');
        }, 500); // Wait for buttons to be populated

        console.log('Checkpoint 2: Before updateChargeSummary definition');

        // Update charge summary to include both services and anodes
        function updateChargeSummary() {
            const chargeDetails = document.getElementById('chargeDetails');
            const chargeButton = document.getElementById('chargeButton');

            // Get service info and price
            const totalElement = document.getElementById('totalCostDisplay');
            const servicePrice = totalElement ? parseFloat(totalElement.textContent.replace('$', '').replace(',', '')) : 0;

            // Get service name from the current selection method
            let serviceName = '';
            if (window.selectedServiceKey && window.serviceData && window.serviceData[window.selectedServiceKey]) {
                serviceName = window.serviceData[window.selectedServiceKey].name;
            }
            
            // Check if this is "Anodes Only" service
            const isAnodesOnlyService = window.selectedServiceKey === 'anodes_only';
            
            // Get anode info
            const anodeItems = Object.values(window.anodeCart || {});
            let anodeSubtotal = 0;
            let anodeLaborTotal = 0;
            let anodeMarkup = 0;
            let anodeTax = 0;
            let anodeTotalWithMarkupAndTax = 0;
            
            if (anodeItems.length > 0) {
                // Get configurable rates
                const taxRate = parseFloat(document.getElementById('taxRate').value) / 100 || 0.1075;
                const markupRate = parseFloat(document.getElementById('markupRate').value) / 100 || 0.20;
                const laborCharge = parseFloat(document.getElementById('laborCharge').value) || 15;
                
                // Calculate anode costs
                anodeSubtotal = anodeItems.reduce((sum, item) => sum + (item.list_price * item.quantity), 0);
                const totalAnodes = anodeItems.reduce((sum, item) => sum + item.quantity, 0);
                anodeLaborTotal = totalAnodes * laborCharge;
                const anodeSubtotalWithLabor = anodeSubtotal + anodeLaborTotal;
                anodeMarkup = anodeSubtotalWithLabor * markupRate;
                const anodeSubtotalWithMarkup = anodeSubtotalWithLabor + anodeMarkup;
                anodeTax = anodeSubtotalWithMarkup * taxRate;
                anodeTotalWithMarkupAndTax = anodeSubtotalWithMarkup + anodeTax;
            }
            
            // Calculate combined total
            const combinedTotal = servicePrice + anodeTotalWithMarkupAndTax;

            // Build the charge details HTML
            let detailsHTML = '';

            // Show customer info if selected, otherwise show placeholder
            if (selectedCustomer) {
                detailsHTML = `
                    <div class="charge-detail-row">
                        <span>Customer:</span>
                        <span>${selectedCustomer.name || 'Unnamed'}</span>
                    </div>
                    <div class="charge-detail-row">
                        <span>Email:</span>
                        <span>${selectedCustomer.email}</span>
                    </div>
                    <div class="charge-detail-row">
                        <span>Payment Method:</span>
                        <span style="color: ${selectedCustomer.payment_method ? '#27ae60' : '#e74c3c'}">
                            ${selectedCustomer.payment_method ?
                                `Card ending in ${selectedCustomer.payment_method.card.last4}` :
                                'No card on file'}
                        </span>
                    </div>
                `;
            } else {
                detailsHTML = `
                    <div class="charge-detail-row">
                        <span>Customer:</span>
                        <span style="color: #e74c3c; font-style: italic;">No customer selected</span>
                    </div>
                    <div class="charge-detail-row">
                        <span></span>
                        <span style="font-size: 12px; color: #7f8c8d;">Select a customer or enter details when charging</span>
                    </div>
                `;
            }
            
            // Add breakdown if there are charges
            if (serviceName || anodeItems.length > 0) {
                detailsHTML += `<hr style="margin: 10px 0; border-color: #e0e0e0;">`;
                
                // Service details
                if (serviceName) {
                    if (isAnodesOnlyService) {
                        // For "Anodes Only" service, show it as a flat fee
                        detailsHTML += `
                            <div class="charge-detail-row">
                                <span>${serviceName} (Service Fee):</span>
                                <span>$${servicePrice.toFixed(2)}</span>
                            </div>
                        `;
                    } else if (servicePrice > 0) {
                        // Regular service with calculated price
                        detailsHTML += `
                            <div class="charge-detail-row">
                                <span>${serviceName}:</span>
                                <span>$${servicePrice.toFixed(2)}</span>
                            </div>
                        `;
                    }
                }
                
                // Anode details
                if (anodeItems.length > 0) {
                    const totalAnodes = anodeItems.reduce((sum, item) => sum + item.quantity, 0);
                    
                    detailsHTML += `
                        <div class="charge-detail-row" style="margin-top: 10px; font-weight: 600;">
                            <span>Zinc Anodes (${totalAnodes} items):</span>
                            <span></span>
                        </div>
                        <div class="charge-detail-row" style="padding-left: 20px; font-size: 0.95em;">
                            <span>Parts Cost:</span>
                            <span>$${anodeSubtotal.toFixed(2)}</span>
                        </div>
                        <div class="charge-detail-row" style="padding-left: 20px; font-size: 0.95em;">
                            <span>Labor (${totalAnodes} Ã— $${parseFloat(document.getElementById('laborCharge').value || 15).toFixed(2)}):</span>
                            <span>$${anodeLaborTotal.toFixed(2)}</span>
                        </div>
                        <div class="charge-detail-row" style="padding-left: 20px; font-size: 0.95em;">
                            <span>Markup (${(parseFloat(document.getElementById('markupRate').value) || 20)}%):</span>
                            <span>$${anodeMarkup.toFixed(2)}</span>
                        </div>
                        <div class="charge-detail-row" style="padding-left: 20px; font-size: 0.95em;">
                            <span>Tax (${(parseFloat(document.getElementById('taxRate').value) || 10.75)}%):</span>
                            <span>$${anodeTax.toFixed(2)}</span>
                        </div>
                        <div class="charge-detail-row" style="padding-left: 20px; font-weight: 600;">
                            <span>Anode Total:</span>
                            <span>$${anodeTotalWithMarkupAndTax.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                detailsHTML += `<hr style="margin: 10px 0; border-color: #345475;">`;
            
            detailsHTML += `
                <div class="charge-detail-row" style="font-size: 1.1em; font-weight: bold;">
                    <span>Total Amount:</span>
                    <span>
                        $<input type="number" 
                               id="editableAmount" 
                               value="${combinedTotal.toFixed(2)}" 
                               step="0.01" 
                               min="0" 
                               style="width: 100px; border: 1px solid #ddd; padding: 4px; border-radius: 4px;"
                               oninput="updateChargeButton()">
                    </span>
                </div>
            `;
            
            chargeDetails.innerHTML = detailsHTML;
            
            // Update charge button based on editable amount
            const editableAmount = parseFloat(document.getElementById('editableAmount')?.value || combinedTotal);

            // Enable button if there's a service configured
            chargeButton.disabled = !window.currentServiceKey;

            // Update button text based on customer selection
            if (selectedCustomer) {
                chargeButton.textContent = selectedCustomer.payment_method ?
                    `ðŸ’³ Charge $${editableAmount.toFixed(2)}` : `ðŸ’³ Charge $${editableAmount.toFixed(2)} (No card on file)`;
            } else {
                chargeButton.textContent = `ðŸ’³ Charge $${editableAmount.toFixed(2)}`;
            }
        }

        // Charge the customer
        async function chargeCustomer() {
            // Check if a service is configured
            const service = window.currentServiceKey;
            if (!service) {
                alert('Please select a service first');
                return;
            }

            // If no customer selected, show the modal
            if (!selectedCustomer) {
                openCustomerSelectionModal();
                return;
            }

            // If customer selected but no payment method
            if (!selectedCustomer.payment_method) {
                alert('Please add a payment method for this customer');
                return;
            }

            const button = document.getElementById('chargeButton');
            const originalText = button.innerHTML;
            button.innerHTML = 'Processing... <span class="loading-spinner"></span>';
            button.classList.add('processing');
            button.disabled = true;

            // Get price from the editable amount field if it exists, otherwise from totalCostDisplay
            const editableAmountEl = document.getElementById('editableAmount');
            let price;
            if (editableAmountEl) {
                price = parseFloat(editableAmountEl.value) || 0;
            } else {
                const totalElement = document.getElementById('totalCostDisplay');
                price = totalElement ? parseFloat(totalElement.textContent.replace('$', '').replace(',', '')) : 0;
            }
            
            // Get selected service key and details
            const selectedServiceEl = document.querySelector('.service-option.selected');
            const serviceKeyFromElement = selectedServiceEl ? selectedServiceEl.dataset.serviceKey : '';
            const serviceTitleEl = selectedServiceEl ? selectedServiceEl.querySelector('.service-title') : null;
            const serviceName = serviceTitleEl ? serviceTitleEl.textContent : '';
            const boatLength = document.getElementById('boatLength').value;
            const boatName = document.getElementById('boatName')?.value || '';

            // Build comprehensive metadata for transaction history
            const metadata = {
                service_key: serviceKeyFromElement || service,
                service_name: serviceName,
                service_date: new Date().toISOString().split('T')[0],
                service_time: new Date().toLocaleTimeString()
            };
            
            // Add boat name and customer boat metadata if provided
            if (boatName) {
                metadata.boat_name = boatName;
            }
            
            // Include customer's boat details from their profile
            if (selectedCustomer.boat_name && !boatName) {
                metadata.boat_name = selectedCustomer.boat_name;
            }
            
            // Only include boat details for cleaning services
            const isCleaningService = service === 'onetime_cleaning' || service === 'recurring_cleaning';
            const isFlatRateService = service === 'item_recovery' || service === 'underwater_inspection';
            
            if (isCleaningService) {
                metadata.boat_length = boatLength;
                metadata.last_paint = document.getElementById('lastPaintedTime')?.value;
                metadata.last_cleaned = document.getElementById('lastCleanedTime')?.value;
                
                // Add hull type and engine configuration if available
                const hullType = document.querySelector('input[name="hull_type"]:checked')?.value;
                if (hullType) {
                    metadata.hull_type = hullType;
                    if (hullType === 'catamaran') metadata.additional_hulls = 1;
                    if (hullType === 'trimaran') metadata.additional_hulls = 2;
                }
                
                const hasTwinEngines = document.getElementById('has_twin_engines')?.checked;
                if (hasTwinEngines) {
                    metadata.twin_engines = true;
                    metadata.engine_type = 'twin';
                } else {
                    metadata.engine_type = 'single';
                }
                
                // Add boat type (sailboat/powerboat)
                const boatType = document.querySelector('input[name="boat_type"]:checked')?.value;
                if (boatType) {
                    metadata.boat_type = boatType;
                }
                
                // Add paint condition and growth level
                const paintCondition = document.getElementById('actualPaintCondition')?.value || document.getElementById('wizardPaintCondition')?.value;
                if (paintCondition) {
                    metadata.paint_condition = paintCondition;
                }
                
                const growthLevel = document.getElementById('actualGrowthLevel')?.value || document.getElementById('wizardGrowthLevel')?.value;
                if (growthLevel) {
                    metadata.growth_level = growthLevel;
                }
            }
            
            // Build detailed description for Stripe transaction
            let description = serviceName || service.replace(/_/g, ' ');
            
            // Add boat details to description
            if (boatName) {
                description = `${description} - ${boatName}`;
            }
            if (!isFlatRateService && boatLength) {
                description += ` (${boatLength}ft)`;
            }
            
            // Add service date
            description += ` - ${new Date().toLocaleDateString()}`;

            try {
                const response = await fetch('http://localhost:3001/api/charge-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerId: selectedCustomer.id,
                        amount: Math.round(price * 100), // Convert to cents
                        description: description,
                        metadata: metadata
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('success', 
                        `âœ… Successfully charged $${price.toFixed(2)} to ${selectedCustomer.name || selectedCustomer.email}<br>
                         Payment ID: ${result.paymentIntent.id}`);
                    
                    // Reset selection after success
                    setTimeout(() => {
                        selectedCustomer = null;
                        document.getElementById('selectedCustomer').classList.remove('active');
                        document.querySelectorAll('.customer-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        updateChargeSummary();
                    }, 3000);
                } else {
                    showResult('error', `âŒ Payment failed: ${result.error}`);
                }
            } catch (error) {
                showResult('error', `âŒ Error processing payment: ${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.classList.remove('processing');
                updateChargeSummary();
            }
        }
        
        // Update charge button when amount is edited
        function updateChargeButton() {
            const editableAmount = parseFloat(document.getElementById('editableAmount')?.value || 0);
            const chargeButton = document.getElementById('chargeButton');
            
            if (selectedCustomer && selectedCustomer.payment_method) {
                chargeButton.disabled = editableAmount === 0;
                chargeButton.textContent = `Charge $${editableAmount.toFixed(2)}`;
            }
        }
        
        console.log('Checkpoint 3: Before making functions global');

        // Make functions globally available
        window.chargeCustomer = chargeCustomer;
        window.updateChargeSummary = updateChargeSummary;

        console.log('Checkpoint 4: Functions made global, updateChargeSummary:', typeof window.updateChargeSummary);

        // If a service was already selected before this script loaded, update the summary now
        if (window.currentServiceKey) {
            console.log('Service already selected, updating charge summary:', window.currentServiceKey);
            updateChargeSummary();
        }

        // Customer Selection Modal Functions
        function openCustomerSelectionModal() {
            const modal = document.getElementById('customerSelectionModal');
            if (modal) {
                modal.style.display = 'block';
                // Populate existing customers list
                const customerList = document.getElementById('modalCustomerList');
                if (customerList && customers) {
                    customerList.innerHTML = customers.map(customer => `
                        <div class="customer-item" onclick="selectModalCustomer('${customer.id}')" style="padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; cursor: pointer; border-radius: 5px;">
                            <div style="font-weight: bold;">${customer.name || 'Unnamed Customer'}</div>
                            <div style="font-size: 14px; color: #666;">${customer.email}${customer.boat_name ? ' â€¢ Boat: ' + customer.boat_name : ''}</div>
                            <div style="font-size: 12px; color: ${customer.payment_method ? 'green' : 'orange'};">
                                ${customer.payment_method ? 'âœ“ Card on file' : 'âš  No card on file'}
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        function closeCustomerSelectionModal() {
            const modal = document.getElementById('customerSelectionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showCustomerTab(tab) {
            const existingTab = document.getElementById('existingCustomerTab');
            const manualTab = document.getElementById('manualEntryTab');
            const existingBtn = document.getElementById('selectExistingTab');
            const manualBtn = document.getElementById('manualEntryTab');

            if (tab === 'existing') {
                if (existingTab) existingTab.style.display = 'block';
                if (manualTab) manualTab.style.display = 'none';
                if (existingBtn) {
                    existingBtn.style.background = '#345475';
                    existingBtn.style.color = 'white';
                    existingBtn.classList.add('active');
                }
                if (manualBtn) {
                    manualBtn.style.background = '#e0e0e0';
                    manualBtn.style.color = '#333';
                    manualBtn.classList.remove('active');
                }
            } else {
                if (existingTab) existingTab.style.display = 'none';
                if (manualTab) manualTab.style.display = 'block';
                if (manualBtn) {
                    manualBtn.style.background = '#345475';
                    manualBtn.style.color = 'white';
                    manualBtn.classList.add('active');
                }
                if (existingBtn) {
                    existingBtn.style.background = '#e0e0e0';
                    existingBtn.style.color = '#333';
                    existingBtn.classList.remove('active');
                }
            }
        }

        let modalSelectedCustomerId = null;

        function selectModalCustomer(customerId) {
            modalSelectedCustomerId = customerId;
            // Highlight selected customer
            document.querySelectorAll('#modalCustomerList .customer-item').forEach(el => {
                el.style.background = 'white';
            });
            event.currentTarget.style.background = '#e8f4ff';
        }

        async function proceedWithSelectedCustomer() {
            if (!modalSelectedCustomerId) {
                alert('Please select a customer');
                return;
            }

            // Find and set the selected customer
            selectedCustomer = customers.find(c => c.id === modalSelectedCustomerId);
            if (!selectedCustomer) {
                alert('Customer not found');
                return;
            }

            // Check if customer has payment method
            if (!selectedCustomer.payment_method) {
                if (confirm('This customer has no payment method on file. Would you like to add one now?')) {
                    closeCustomerSelectionModal();
                    showAddPaymentMethod(selectedCustomer.id);
                    return;
                } else {
                    return;
                }
            }

            // Close modal and proceed with charge
            closeCustomerSelectionModal();
            updateChargeSummary();
            // Call chargeCustomer again now that we have a customer selected
            chargeCustomer();
        }

        async function proceedWithManualCustomer() {
            const name = document.getElementById('manualCustomerName')?.value;
            const email = document.getElementById('manualCustomerEmail')?.value;
            const phone = document.getElementById('manualCustomerPhone')?.value;
            const boatName = document.getElementById('manualBoatName')?.value;
            const paymentMethod = document.getElementById('manualPaymentMethod')?.value;

            if (!name || !email) {
                alert('Please enter at least name and email');
                return;
            }

            // Here we would typically create a new customer via API
            // For now, we'll just create a temporary customer object
            const tempCustomer = {
                id: 'temp_' + Date.now(),
                name: name,
                email: email,
                phone: phone,
                boat_name: boatName,
                payment_method: paymentMethod ? { type: 'manual', details: paymentMethod } : null
            };

            // In production, this would make an API call to create the customer
            try {
                // Simulate API call
                console.log('Creating customer:', tempCustomer);
                alert('Manual customer entry would create: ' + name + ' (' + email + ')');

                // For demo purposes, add to customers array and select
                customers.push(tempCustomer);
                selectedCustomer = tempCustomer;

                closeCustomerSelectionModal();
                updateChargeSummary();

                // Note: In production, you'd need to handle payment method properly
                if (!paymentMethod) {
                    alert('Note: Customer created without payment method. Payment method would need to be added before charging.');
                }
            } catch (error) {
                console.error('Error creating customer:', error);
                alert('Failed to create customer. Please try again.');
            }
        }

        // Modal search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const modalSearch = document.getElementById('modalCustomerSearch');
            if (modalSearch) {
                modalSearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const customerItems = document.querySelectorAll('#modalCustomerList .customer-item');

                    customerItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                    });
                });
            }
        });

        // Make modal functions globally available
        window.openCustomerSelectionModal = openCustomerSelectionModal;
        window.closeCustomerSelectionModal = closeCustomerSelectionModal;
        window.showCustomerTab = showCustomerTab;
        window.selectModalCustomer = selectModalCustomer;
        window.proceedWithSelectedCustomer = proceedWithSelectedCustomer;
        window.proceedWithManualCustomer = proceedWithManualCustomer;
        window.updateChargeButton = updateChargeButton;

        // Show result message
        function showResult(type, message) {
            const resultEl = document.getElementById('chargeResult');
            resultEl.className = `charge-result ${type}`;
            resultEl.innerHTML = message;
            resultEl.style.display = 'block';
            
            setTimeout(() => {
                resultEl.style.display = 'none';
            }, 5000);
        }
        
        // Anode Charging Functions
        let anodeCart = {};
        let selectedBoat = null;
        let anodeCatalog = [];
        let currentCategory = 'all';
        
        // Toggle anode section visibility
        window.toggleAnodeSection = function() {
            const section = document.getElementById('anodeSection');
            if (!section) {
                console.error('Anode section not found');
                return;
            }
            
            // Toggle visibility
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                section.classList.add('active');
                
                // Load anode catalog if not already loaded
                if (anodeCatalog.length === 0) {
                    console.log('Loading anode catalog...');
                    loadAnodeCatalog();
                }
                
                // Set today's date
                const scheduleDate = document.getElementById('scheduleDate');
                if (scheduleDate) {
                    scheduleDate.value = new Date().toISOString().split('T')[0];
                }
                
                // Scroll to the section
                setTimeout(() => {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
            } else {
                section.style.display = 'none';
                section.classList.remove('active');
            }
        }; // End of toggleAnodeSection

        // Load anode catalog from JSON file
        async function loadAnodeCatalog() {
            try {
                // Try to load the full comprehensive catalog first
                let response = await fetch('/full-boatzincs-catalog.json');
                if (!response.ok) {
                    // Try the other comprehensive catalog
                    response = await fetch('/complete-zinc-catalog.json');
                    if (!response.ok) {
                        // Try zinc anodes catalog
                        response = await fetch('/zinc-anodes-catalog.json');
                        if (!response.ok) {
                            // Fallback to original catalog
                            response = await fetch('/anode-catalog.json');
                        }
                    }
                }
                const data = await response.json();
                anodeCatalog = data.anodes || data;
                console.log(`Loaded ${anodeCatalog.length} anodes from catalog`);
                displayAnodes();
                updateCategoryButtons();
            } catch (error) {
                console.error('Failed to load anode catalog:', error);
                // Use hardcoded catalog as fallback
                anodeCatalog = [
                    { boatzincs_id: "ZSC-1", name: "Shaft Collar Zinc - 1\"", category: "shaft", list_price: 22.99 },
                    { boatzincs_id: "ZSC-1.25", name: "Shaft Collar Zinc - 1.25\"", category: "shaft", list_price: 24.99 },
                    { boatzincs_id: "ZSC-1.5", name: "Shaft Collar Zinc - 1.5\"", category: "shaft", list_price: 27.99 },
                    { boatzincs_id: "ZHB-3", name: "Hull Bolt-On Zinc - 3 lb", category: "hull", list_price: 54.99 },
                    { boatzincs_id: "ZHB-6", name: "Hull Bolt-On Zinc - 6 lb", category: "hull", list_price: 82.99 },
                    { boatzincs_id: "ZPN-1/2", name: "Engine Pencil Zinc - 1/2\" NPT", category: "engine", list_price: 6.99 },
                    { boatzincs_id: "ZPN-3/4", name: "Engine Pencil Zinc - 3/4\" NPT", category: "engine", list_price: 8.99 },
                    { boatzincs_id: "ZPH-A", name: "Propeller Hub Zinc - Alpha", category: "propeller", list_price: 18.99 },
                    { boatzincs_id: "ZRD-2", name: "Rudder Zinc - 2\"", category: "rudder", list_price: 45.99 },
                    { boatzincs_id: "ZTT-M", name: "Trim Tab Zinc - Medium", category: "trim_tab", list_price: 16.99 }
                ];
                displayAnodes();
            }
        }
        
        // Display anodes in grid
        function displayAnodes() {
            const grid = document.getElementById('anodeGrid');
            let filtered;
            
            if (currentCategory === 'all') {
                filtered = anodeCatalog;
            } else if (currentCategory === 'shaft') {
                // Include all shaft categories
                filtered = anodeCatalog.filter(a => 
                    a.category === 'shaft' || 
                    a.category === 'shaft_anodes_standard' || 
                    a.category === 'shaft_anodes_metric' ||
                    a.category.includes('shaft')
                );
            } else if (currentCategory === 'hull') {
                // Include all hull categories
                filtered = anodeCatalog.filter(a => 
                    a.category === 'hull' || 
                    a.category === 'hull_anodes_bolt_on' || 
                    a.category === 'hull_anodes_weld_on' ||
                    a.category.includes('hull')
                );
            } else if (currentCategory === 'engine') {
                // Include all engine categories
                filtered = anodeCatalog.filter(a => 
                    a.category === 'engine' || 
                    a.category === 'engine_anodes' ||
                    a.category.includes('engine')
                );
            } else if (currentCategory === 'rudder') {
                // Include both rudder and trim_tab categories
                filtered = anodeCatalog.filter(a => 
                    a.category === 'rudder' || 
                    a.category === 'trim_tab' ||
                    a.category.includes('rudder') ||
                    a.category.includes('trim')
                );
            } else {
                filtered = anodeCatalog.filter(a => 
                    a.category === currentCategory ||
                    a.category.includes(currentCategory)
                );
            }
            
            grid.innerHTML = filtered.map(anode => `
                <div class="anode-item" data-id="${anode.boatzincs_id}">
                    <div class="anode-name">${anode.name}</div>
                    <div class="anode-price">$${anode.list_price.toFixed(2)}</div>
                    <div class="anode-quantity">
                        <button class="quantity-btn" onclick="updateAnodeQuantity('${anode.boatzincs_id}', -1)">-</button>
                        <input type="number" class="quantity-input" id="qty-${anode.boatzincs_id}" 
                               value="${anodeCart[anode.boatzincs_id]?.quantity || 0}" 
                               onchange="setAnodeQuantity('${anode.boatzincs_id}', this.value)" min="0" max="99">
                        <button class="quantity-btn" onclick="updateAnodeQuantity('${anode.boatzincs_id}', 1)">+</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Update category button counts
        function updateCategoryButtons() {
            const counts = {
                all: anodeCatalog.length,
                shaft: anodeCatalog.filter(a => a.category.includes('shaft')).length,
                hull: anodeCatalog.filter(a => a.category.includes('hull')).length,
                engine: anodeCatalog.filter(a => a.category.includes('engine')).length,
                propeller: anodeCatalog.filter(a => a.category.includes('propeller')).length,
                rudder: anodeCatalog.filter(a => a.category.includes('rudder') || a.category.includes('trim')).length,
                collar: anodeCatalog.filter(a => a.category.includes('collar')).length,
                outboard: anodeCatalog.filter(a => a.category.includes('outboard')).length
            };
            
            // Update button text with counts
            document.querySelector('.category-btn[onclick="filterAnodes(\'all\')"]').textContent = `All (${counts.all})`;
            document.querySelector('.category-btn[onclick="filterAnodes(\'shaft\')"]').textContent = `Shaft (${counts.shaft})`;
            document.querySelector('.category-btn[onclick="filterAnodes(\'hull\')"]').textContent = `Hull (${counts.hull})`;
            document.querySelector('.category-btn[onclick="filterAnodes(\'engine\')"]').textContent = `Engine (${counts.engine})`;
            document.querySelector('.category-btn[onclick="filterAnodes(\'propeller\')"]').textContent = `Propeller (${counts.propeller})`;
            document.querySelector('.category-btn[onclick="filterAnodes(\'rudder\')"]').textContent = `Rudder/Trim (${counts.rudder})`;
            document.querySelector('.category-btn[onclick="filterAnodes(\'collar\')"]').textContent = `Collar (${counts.collar})`;
            document.querySelector('.category-btn[onclick="filterAnodes(\'outboard\')"]').textContent = `Outboard (${counts.outboard})`;
        }
        
        // Filter anodes by category
        window.filterAnodes = function(category) {
            currentCategory = category;
            
            // Update button states
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayAnodes();
        }; // End of filterAnodes

        // Update anode quantity
        window.updateAnodeQuantity = function(anodeId, change) {
            const anode = anodeCatalog.find(a => a.boatzincs_id === anodeId);
            if (!anode) return;
            
            if (!anodeCart[anodeId]) {
                anodeCart[anodeId] = { ...anode, quantity: 0 };
            }
            
            anodeCart[anodeId].quantity = Math.max(0, anodeCart[anodeId].quantity + change);
            
            if (anodeCart[anodeId].quantity === 0) {
                delete anodeCart[anodeId];
            }
            
            document.getElementById(`qty-${anodeId}`).value = anodeCart[anodeId]?.quantity || 0;
            updateCart();
        }; // End of updateAnodeQuantity

        // Set anode quantity directly
        window.setAnodeQuantity = function(anodeId, value) {
            const quantity = parseInt(value) || 0;
            if (quantity === 0) {
                delete anodeCart[anodeId];
            } else {
                const anode = anodeCatalog.find(a => a.boatzincs_id === anodeId);
                if (anode) {
                    anodeCart[anodeId] = { ...anode, quantity };
                }
            }
            updateCart();
        }; // End of setAnodeQuantity

        // Update cart display and totals
        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const items = Object.values(anodeCart);
            
            if (items.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; color: #999;">No anodes selected</p>';
                document.getElementById('anodeSubtotal').textContent = '$0.00';
                document.getElementById('anodeLaborTotal').textContent = '$0.00';
                document.getElementById('anodeTax').textContent = '$0.00';
                document.getElementById('anodeMarkup').textContent = '$0.00';
                document.getElementById('anodeTotal').textContent = '$0.00';
                document.getElementById('laborCount').textContent = '0';
                document.getElementById('chargeAnodeBtn').disabled = true;
                return;
            }
            
            // Display cart items
            cartItems.innerHTML = items.map(item => `
                <div class="cart-item">
                    <span>${item.quantity}x ${item.name}</span>
                    <span>$${(item.list_price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            
            // Get configurable rates
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100 || 0.1075;
            const markupRate = parseFloat(document.getElementById('markupRate').value) / 100 || 0.20;
            const laborCharge = parseFloat(document.getElementById('laborCharge').value) || 15;
            
            // Calculate totals
            const subtotal = items.reduce((sum, item) => sum + (item.list_price * item.quantity), 0);
            const totalAnodes = items.reduce((sum, item) => sum + item.quantity, 0);
            const laborTotal = totalAnodes * laborCharge;
            const subtotalWithLabor = subtotal + laborTotal;
            const markup = subtotalWithLabor * markupRate;  // Markup BEFORE tax
            const subtotalWithMarkup = subtotalWithLabor + markup;
            const tax = subtotalWithMarkup * taxRate;  // Tax on marked-up amount
            const total = subtotalWithMarkup + tax;
            
            // Update display
            document.getElementById('anodeSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('laborCount').textContent = totalAnodes;
            document.getElementById('laborRate').textContent = laborCharge.toFixed(2);
            document.getElementById('anodeLaborTotal').textContent = `$${laborTotal.toFixed(2)}`;
            document.getElementById('taxRateDisplay').textContent = (taxRate * 100).toFixed(2);
            document.getElementById('anodeTax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('markupRateDisplay').textContent = (markupRate * 100).toFixed(1);
            document.getElementById('anodeMarkup').textContent = `$${markup.toFixed(2)}`;
            document.getElementById('anodeTotal').textContent = `$${total.toFixed(2)}`;
            
            document.getElementById('chargeAnodeBtn').disabled = !selectedCustomer;
            
            // Also update the main charge summary to include anodes
            updateChargeSummary();
        }
        
        // Add updatePricing function to recalculate when rates change
        function updatePricing() {
            updateCart();
        }
        
        
        // Load daily schedule (mock for now)
        window.loadDailySchedule = function() {
            const date = document.getElementById('scheduleDate').value;
            const scheduleList = document.getElementById('boatScheduleList');
            
            // Mock data - in production, this would fetch from database
            const mockSchedule = [
                { boat_id: '1', boat_name: 'Serenity', customer_name: 'John Smith', completed: false },
                { boat_id: '2', boat_name: 'Wind Dancer', customer_name: 'Sarah Johnson', completed: false },
                { boat_id: '3', boat_name: 'Blue Horizon', customer_name: 'Mike Wilson', completed: true }
            ];
            
            scheduleList.innerHTML = mockSchedule.map(boat => `
                <div class="boat-schedule-item ${boat.completed ? 'completed' : ''}" 
                     onclick="selectBoatFromSchedule('${boat.boat_id}', '${boat.boat_name}', '${boat.customer_name}')">
                    <div class="boat-info">
                        <div class="boat-name">${boat.boat_name}</div>
                        <div class="boat-customer">${boat.customer_name}</div>
                    </div>
                    ${boat.completed ? '<div class="boat-status">âœ“ Completed</div>' : ''}
                </div>
            `).join('');
        }; // End of loadDailySchedule

        // Select boat from schedule
        window.selectBoatFromSchedule = function(boatId, boatName, customerName) {
            selectedBoat = { id: boatId, name: boatName, customer: customerName };
            
            // Update UI
            document.querySelectorAll('.boat-schedule-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show anode selector
            document.getElementById('anodeSelector').style.display = 'block';
            document.getElementById('selectedBoatName').textContent = boatName;
            
            // Clear cart for new boat
            anodeCart = {};
            displayAnodes();
            updateCart();
        }; // End of selectBoatFromSchedule

        // Upload schedule CSV
        window.uploadScheduleCSV = function() {
            alert('CSV upload feature coming soon. For now, use the manual schedule entry.');
        }; // End of uploadScheduleCSV

        // Generate quote for customer (anodes only)
        window.generateQuote = function() {
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 10.75;
            const laborCharge = parseFloat(document.getElementById('laborCharge').value) || 15;
            
            // Build URL parameters
            const params = new URLSearchParams();
            params.append('tax', taxRate);
            params.append('labor', laborCharge);
            
            if (selectedCustomer) {
                params.append('customer', selectedCustomer.name || selectedCustomer.email || '');
            }
            
            if (selectedBoat) {
                params.append('boat', selectedBoat.name || '');
            }
            
            // Open quote page in new tab
            window.open('/anode-quote.html?' + params.toString(), '_blank');
        }; // End of generateQuote

        // Generate combined quote for services and anodes
        window.generateCombinedQuote = function() {
            // Get all current data
            const boatLengthEl = document.getElementById('boatLength');
            const boatLength = boatLengthEl ? boatLengthEl.value : '';
            
            const selectedServiceEl = document.querySelector('.service-option.selected');
            const serviceTitleEl = selectedServiceEl ? selectedServiceEl.querySelector('.service-title') : null;
            const serviceName = serviceTitleEl ? serviceTitleEl.textContent : '';
            const serviceKey = selectedServiceEl ? selectedServiceEl.dataset.service : '';
            
            const totalElement = document.getElementById('totalCostDisplay');
            const servicePrice = totalElement ? parseFloat(totalElement.textContent.replace('$', '').replace(',', '')) : 0;
            
            // Build quote data
            const quoteData = {
                customer: selectedCustomer ? (selectedCustomer.name || selectedCustomer.email || '') : '',
                boat: selectedBoat ? selectedBoat.name : '',
                boatLength: boatLength,
                service: {
                    name: serviceName,
                    key: serviceKey,
                    price: servicePrice
                },
                anodes: Object.values(window.anodeCart || {}),
                anodeConfig: {
                    taxRate: parseFloat(document.getElementById('taxRate')?.value || 10.75),
                    markupRate: parseFloat(document.getElementById('markupRate')?.value || 20),
                    laborCharge: parseFloat(document.getElementById('laborCharge')?.value || 15)
                }
            };
            
            // Store quote data in localStorage
            localStorage.setItem('currentQuote', JSON.stringify(quoteData));
            
            // Open comprehensive quote page
            window.open('/comprehensive-quote.html?load=current', '_blank');
        }; // End of generateCombinedQuote

        // Charge customer for anodes
        window.chargeAnodes = async function() {
            if (!selectedCustomer || Object.keys(anodeCart).length === 0) return;
            
            // Get configurable rates
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100 || 0.1075;
            const markupRate = parseFloat(document.getElementById('markupRate').value) / 100 || 0.20;
            const laborCharge = parseFloat(document.getElementById('laborCharge').value) || 15;
            
            const items = Object.values(anodeCart);
            const subtotal = items.reduce((sum, item) => sum + (item.list_price * item.quantity), 0);
            const totalAnodes = items.reduce((sum, item) => sum + item.quantity, 0);
            const laborTotal = totalAnodes * laborCharge;
            const subtotalWithLabor = subtotal + laborTotal;
            const markup = subtotalWithLabor * markupRate;  // Markup BEFORE tax
            const subtotalWithMarkup = subtotalWithLabor + markup;
            const tax = subtotalWithMarkup * taxRate;  // Tax on marked-up amount
            const total = subtotalWithMarkup + tax;
            
            const description = items.map(item => 
                `${item.quantity}x ${item.name}`
            ).join(', ') + ` (includes $${laborTotal.toFixed(2)} labor)`;
            
            try {
                const response = await fetch('http://localhost:3001/api/charge-anode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: selectedCustomer.stripe_customer_id,
                        amount: Math.round(total * 100), // Convert to cents
                        description: `Anode Replacement: ${description}`,
                        metadata: {
                            boat_id: selectedBoat?.id,
                            boat_name: selectedBoat?.name,
                            items: JSON.stringify(items),
                            subtotal: subtotal.toFixed(2),
                            labor: laborTotal.toFixed(2),
                            tax: tax.toFixed(2),
                            markup: markup.toFixed(2),
                            tax_rate: (taxRate * 100).toFixed(2) + '%',
                            markup_rate: (markupRate * 100).toFixed(1) + '%',
                            labor_per_anode: laborCharge.toFixed(2)
                        }
                    })
                });
                
                if (response.ok) {
                    showResult('success', `Successfully charged $${total.toFixed(2)} for anode replacement`);
                    // Clear cart
                    anodeCart = {};
                    updateCart();
                    displayAnodes();
                } else {
                    throw new Error('Charge failed');
                }
            } catch (error) {
                showResult('error', 'Failed to charge customer: ' + error.message);
            }
        }; // End of chargeAnodes function

        console.log('Module script completed successfully');
        }} catch (err) {
            console.error('Module script error caught:', err);
            console.error('Error stack:', err.stack);
        }
    </script>

    <!-- Load admin.js module -->
    <script type="module">
        import { AdminApp } from './admin.js';
        window.adminApp = new AdminApp();
    </script>

    <!-- Hamburger Menu Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const navToggle = document.getElementById('navToggle');
            const navLinks = document.getElementById('navLinks');

            if (navToggle && navLinks) {
                // Toggle menu on button click
                navToggle.addEventListener('click', function() {
                    navToggle.classList.toggle('active');
                    navLinks.classList.toggle('active');
                });

                // Close menu when clicking a link
                const links = navLinks.querySelectorAll('a');
                links.forEach(link => {
                    link.addEventListener('click', function() {
                        navToggle.classList.remove('active');
                        navLinks.classList.remove('active');
                    });
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!navToggle.contains(event.target) && !navLinks.contains(event.target)) {
                        navToggle.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                });
            }
        });
    </script>
    </main>
</body>
</html>
